<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema 911 - Gesti√≥n Inteligente de C√°maras</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        
        .app-container {
            display: grid;
            grid-template-columns: 280px 1fr 400px;
            gap: 20px;
            height: 100vh;
            padding: 20px;
        }
        
        .nav-panel, .main-content, .assistant-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .main-content {
            overflow-y: auto;
        }
        
        .assistant-panel {
            display: flex;
            flex-direction: column;
            max-height: 100%;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-1px);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            gap: 6px;
        }
        
        .status-active {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
        }
        
        .status-inactive {
            background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            color: white;
        }
        
        .status-maintenance {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            color: white;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .fade-in { 
            animation: fadeIn 0.5s ease-out; 
        }
        
        .custom-scrollbar::-webkit-scrollbar { 
            width: 8px; 
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }
        
        .message-user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 18px 18px 4px 18px;
            padding: 12px 16px;
            margin: 8px 0;
            max-width: 85%;
            margin-left: auto;
            word-wrap: break-word;
        }
        
        .message-ai {
            background: rgba(102, 126, 234, 0.1);
            color: #333;
            border-radius: 18px 18px 18px 4px;
            padding: 12px 16px;
            margin: 8px 0;
            max-width: 85%;
            word-wrap: break-word;
        }
        
        .camera-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .camera-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            border-left: 4px solid;
        }
        
        .camera-card.active { 
            border-left-color: #10b981; 
        }
        
        .camera-card.inactive { 
            border-left-color: #ef4444; 
        }
        
        .camera-card.maintenance { 
            border-left-color: #f59e0b; 
        }
        
        .camera-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .modal-overlay {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from { 
                opacity: 0; 
                transform: scale(0.9) translateY(-20px); 
            }
            to { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
            }
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            ring: 2px;
            ring-color: #667eea;
            border-color: #667eea;
        }
        
        .mobile-menu-btn {
            display: none;
        }
        
        @media (max-width: 1200px) {
            .app-container {
                grid-template-columns: 1fr;
                height: auto;
                min-height: 100vh;
            }
            
            .nav-panel, .assistant-panel {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 1000;
                margin: 20px;
                max-height: calc(100vh - 40px);
                overflow-y: auto;
            }
            
            .nav-panel.active, .assistant-panel.active {
                display: block;
            }
            
            .mobile-menu-btn {
                display: inline-flex;
            }
        }
        
        @media (max-width: 640px) {
            .app-container {
                padding: 10px;
            }
            
            .camera-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Panel de Navegaci√≥n Izquierdo -->
        <div class="nav-panel custom-scrollbar" id="nav-panel">
            <div style="margin-bottom: 2rem; text-align: center;">
                <div style="width: 64px; height: 64px; margin: 0 auto 1rem; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                    <i class="fas fa-shield-alt" style="color: white; font-size: 1.5rem;"></i>
                </div>
                <h1 style="font-size: 1.5rem; font-weight: 700; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Sistema 911</h1>
                <p style="color: #6b7280; font-size: 0.875rem; margin-top: 0.5rem;">Gesti√≥n Inteligente de C√°maras</p>
            </div>
            
            <button onclick="toggleNavPanel()" class="mobile-menu-btn" style="position: absolute; top: 20px; right: 20px; padding: 10px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <i class="fas fa-times" style="font-size: 1.25rem;"></i>
            </button>
            
            <div style="margin-bottom: 1.5rem;">
                <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-filter" style="color: #667eea;"></i>Filtros R√°pidos
                </h3>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <button onclick="filterByStatus('all')" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-globe"></i>Todas las c√°maras
                    </button>
                    <button onclick="filterByStatus('active')" class="btn" style="width: 100%; background: rgba(16, 185, 129, 0.1); color: #10b981;">
                        <i class="fas fa-check-circle"></i>Activas
                    </button>
                    <button onclick="filterByStatus('inactive')" class="btn" style="width: 100%; background: rgba(239, 68, 68, 0.1); color: #ef4444;">
                        <i class="fas fa-times-circle"></i>Inactivas
                    </button>
                    <button onclick="filterByStatus('maintenance')" class="btn" style="width: 100%; background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                        <i class="fas fa-tools"></i>En Mantenimiento
                    </button>
                </div>
            </div>
            
            <div style="margin-bottom: 1.5rem;">
                <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-chart-bar" style="color: #667eea;"></i>Estad√≠sticas
                </h3>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-radius: 0.5rem; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%);">
                        <span style="color: #374151;">Total</span>
                        <span style="font-weight: 700; font-size: 1.125rem;" id="total-cameras">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-radius: 0.5rem; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(52, 211, 153, 0.1) 100%);">
                        <span style="color: #374151;">Activas</span>
                        <span style="font-weight: 700; font-size: 1.125rem; color: #10b981;" id="active-cameras">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-radius: 0.5rem; background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(248, 113, 113, 0.1) 100%);">
                        <span style="color: #374151;">Inactivas</span>
                        <span style="font-weight: 700; font-size: 1.125rem; color: #ef4444;" id="inactive-cameras">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-radius: 0.5rem; background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(251, 191, 36, 0.1) 100%);">
                        <span style="color: #374151;">Mantenimiento</span>
                        <span style="font-weight: 700; font-size: 1.125rem; color: #f59e0b;" id="maintenance-cameras">0</span>
                    </div>
                </div>
            </div>
            
            <!-- NUEVA SECCI√ìN: FILTROS POR UBICACI√ìN JER√ÅRQUICOS -->
            <div style="margin-bottom: 1.5rem;">
                <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-map-marker-alt" style="color: #667eea;"></i>Ubicaciones
                </h3>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <div>
                        <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem; color: #374151;">Departamento</label>
                        <select id="filter-dept" onchange="onDeptFilterChange(this.value)" style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #d1d5db;">
                            <option value="all">Todos los departamentos</option>
                            <!-- Se llena din√°micamente -->
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem; color: #374151;">Municipio</label>
                        <select id="filter-mun" onchange="onMunFilterChange(this.value)" style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #d1d5db;" disabled>
                            <option value="all">Todos los municipios</option>
                            <!-- Se llena din√°micamente seg√∫n departamento -->
                        </select>
                    </div>
                </div>
            </div>
            
            <div>
                <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-bolt" style="color: #667eea;"></i>Acciones R√°pidas
                </h3>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <button onclick="toggleMapFullscreen()" class="btn" style="width: 100%; background: linear-gradient(135deg, #10b981 0%, #34d399 100%); color: white;">
                        <i class="fas fa-map"></i>Ver Mapa
                    </button>
                    <button onclick="exportData()" class="btn" style="width: 100%; background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                        <i class="fas fa-download"></i>Exportar Datos
                    </button>
                    <button onclick="showSiteModal()" class="btn" style="width: 100%; background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white;">
                        <i class="fas fa-building"></i>Nuevo Sitio
                    </button>
                    <button onclick="addNewCamera()" class="btn" style="width: 100%; background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                        <i class="fas fa-plus"></i>Nueva C√°mara
                    </button>
                    <button onclick="showDepartmentManager()" class="btn" style="width: 100%; background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%); color: white;">
                        <i class="fas fa-map"></i>Gestionar Departamentos
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Contenido Principal Central -->
        <div class="main-content custom-scrollbar">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                <div>
                    <h2 style="font-size: 1.5rem; font-weight: 700; color: #1f2937;">Dashboard del Sistema</h2>
                    <p style="color: #6b7280;" id="current-time"></p>
                </div>
                <div style="display: flex; gap: 0.75rem;">
                    <button onclick="toggleNavPanel()" class="btn mobile-menu-btn">
                        <i class="fas fa-bars"></i>Men√∫
                    </button>
                    <button onclick="toggleAssistantPanel()" class="btn btn-primary">
                        <i class="fas fa-robot"></i>Asistente IA
                    </button>
                </div>
            </div>
            
            <!-- Tarjetas de estad√≠sticas -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                <div class="card">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-video" style="color: white; font-size: 1.25rem;"></i>
                        </div>
                        <div>
                            <p style="color: #6b7280; font-size: 0.875rem;">C√°maras Totales</p>
                            <h3 style="font-size: 1.5rem; font-weight: 700;" id="total-count">0</h3>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #10b981 0%, #34d399 100%); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-check-circle" style="color: white; font-size: 1.25rem;"></i>
                        </div>
                        <div>
                            <p style="color: #6b7280; font-size: 0.875rem;">Activas</p>
                            <h3 style="font-size: 1.5rem; font-weight: 700; color: #10b981;" id="active-count">0</h3>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #ef4444 0%, #f87171 100%); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-exclamation-triangle" style="color: white; font-size: 1.25rem;"></i>
                        </div>
                        <div>
                            <p style="color: #6b7280; font-size: 0.875rem;">Inactivas</p>
                            <h3 style="font-size: 1.5rem; font-weight: 700; color: #ef4444;" id="inactive-count">0</h3>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-project-diagram" style="color: white; font-size: 1.25rem;"></i>
                        </div>
                        <div>
                            <p style="color: #6b7280; font-size: 0.875rem;">Cascadas</p>
                            <h3 style="font-size: 1.5rem; font-weight: 700; color: #f59e0b;" id="cascadas-count">0</h3>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Mapa -->
            <div class="card" style="margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                    <h3 style="font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-map-marked-alt" style="color: #667eea;"></i>Mapa en Tiempo Real
                    </h3>
                    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                        <button onclick="editMapSettings()" class="btn" style="background: rgba(147, 51, 234, 0.1); color: #8b5cf6;">
                            <i class="fas fa-cog"></i>Configurar
                        </button>
                        <button onclick="refreshMap()" class="btn" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                            <i class="fas fa-sync-alt"></i>Actualizar
                        </button>
                        <button onclick="toggleMapFullscreen()" class="btn" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
                            <i class="fas fa-expand"></i>Pantalla completa
                        </button>
                    </div>
                </div>
                
                <!-- Configuraci√≥n del mapa -->
                <div id="map-config" style="display: none; background: #f9fafb; padding: 1rem; border-radius: 0.75rem; margin-bottom: 1rem;">
                    <h4 style="font-weight: 600; margin-bottom: 1rem;">‚öôÔ∏è Configuraci√≥n del Mapa</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div>
                            <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">URL del Mapa</label>
                            <input type="text" id="map-url" value="https://www.google.com/maps/d/embed?mid=156urWy3HLJdu7wGK8gHTFX4K1oXIasE&ehbc=2E312F&noprof=1" style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #d1d5db; font-size: 0.875rem;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Ancho (px)</label>
                            <input type="number" id="map-width" value="100" min="50" max="100" style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #d1d5db;">
                            <span style="font-size: 0.75rem; color: #6b7280;">Porcentaje del contenedor</span>
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Alto (px)</label>
                            <input type="number" id="map-height" value="400" min="200" max="800" step="50" style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #d1d5db;">
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.75rem; margin-top: 1rem;">
                        <button onclick="applyMapSettings()" class="btn btn-primary">
                            <i class="fas fa-check"></i>Aplicar cambios
                        </button>
                        <button onclick="resetMapSettings()" class="btn" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">
                            <i class="fas fa-undo"></i>Restaurar predeterminado
                        </button>
                        <button onclick="toggleMapConfig()" class="btn" style="background: #e5e7eb; color: #374151;">
                            Cerrar
                        </button>
                    </div>
                </div>
                
                <div id="map-container" style="position: relative; border-radius: 15px; overflow: hidden; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);">
                    <iframe id="main-map" src="https://www.google.com/maps/d/embed?mid=156urWy3HLJdu7wGK8gHTFX4K1oXIasE&ehbc=2E312F&noprof=1" style="width: 100%; height: 400px; border: none;" loading="lazy"></iframe>
                </div>
                <div style="margin-top: 1rem; display: flex; align-items: center; justify-content: space-between; font-size: 0.875rem; color: #6b7280; flex-wrap: wrap; gap: 1rem;">
                    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                        <span style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="width: 12px; height: 12px; border-radius: 50%; background: #10b981;"></span>
                            C√°mara Activa
                        </span>
                        <span style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="width: 12px; height: 12px; border-radius: 50%; background: #ef4444;"></span>
                            C√°mara Inactiva
                        </span>
                        <span style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="width: 12px; height: 12px; border-radius: 50%; background: #f59e0b;"></span>
                            En Mantenimiento
                        </span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span id="map-update-time">√öltima actualizaci√≥n --:--</span>
                        <button onclick="copyMapUrl()" style="background: none; border: none; color: #667eea; cursor: pointer; font-size: 0.875rem; font-weight: 500;">
                            <i class="fas fa-copy"></i> Copiar URL
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Lista de c√°maras -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                    <h3 style="font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-list" style="color: #667eea;"></i>C√°maras del Sistema
                    </h3>
                    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                        <input type="text" id="search-cameras" placeholder="Buscar c√°maras..." style="padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #d1d5db;" oninput="searchCameras(this.value)">
                        <button onclick="toggleEditMode()" id="edit-mode-btn" class="btn">
                            <i class="fas fa-edit"></i>Editar
                        </button>
                    </div>
                </div>
                <div id="cameras-list" class="camera-grid"></div>
            </div>
        </div>
        
        <!-- Panel Asistente IA Derecho -->
        <div class="assistant-panel custom-scrollbar" id="assistant-panel">
            <button onclick="toggleAssistantPanel()" class="mobile-menu-btn" style="position: absolute; top: 20px; right: 20px; padding: 10px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <i class="fas fa-times" style="font-size: 1.25rem;"></i>
            </button>
            
            <div style="margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                    <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-robot" style="color: white; font-size: 1.25rem;"></i>
                    </div>
                    <div>
                        <h2 style="font-size: 1.25rem; font-weight: 700;">Asistente IA 911</h2>
                        <p style="color: #6b7280; font-size: 0.875rem;">Tu ayudante inteligente</p>
                    </div>
                </div>
            </div>
            
            <div id="ai-status" style="padding: 0.75rem; border-radius: 0.5rem; background: rgba(16, 185, 129, 0.1); margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="width: 8px; height: 8px; border-radius: 50%; background: #10b981; animation: pulse 2s ease-in-out infinite;"></span>
                    <span style="font-weight: 500; color: #059669;">IA Conectada y lista</span>
                </div>
            </div>
            
            <div id="chat-history" style="flex: 1; overflow-y: auto; margin-bottom: 1.5rem; min-height: 200px;">
                <div class="message-ai fade-in">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <div style="width: 24px; height: 24px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-robot" style="font-size: 0.75rem; color: white;"></i>
                        </div>
                        <div style="font-weight: 600; color: #667eea;">Asistente IA 911 - Sistema Inteligente</div>
                    </div>
                    <div style="margin: 0; white-space: pre-wrap; line-height: 1.5;">
                        ¬°Hola! Soy tu asistente inteligente especializado en el sistema de c√°maras 911. Puedo ayudarte con:
                        
                        ‚Ä¢ <strong>Conteo espec√≠fico:</strong> ¬øCu√°ntas LPR en X ciudad/departamento?
                        ‚Ä¢ <strong>Conexiones t√©cnicas:</strong> C√≥mo conectarse a sitios, c√°maras, switches
                        ‚Ä¢ <strong>Configuraci√≥n de red:</strong> IP, Gateway, Puerta de Enlace paso a paso
                        ‚Ä¢ <strong>Aprendizaje continuo:</strong> Puedo aprender nueva informaci√≥n que me ense√±es
                        ‚Ä¢ <strong>Soporte t√©cnico:</strong> Soluci√≥n de problemas y procedimientos
                        
                        <strong>üí° Ejemplos:</strong>
                        ‚Ä¢ "¬øCu√°ntas LPR en Santa Rosa de Cop√°n?"
                        ‚Ä¢ "C√≥mo conectarse al sitio SRC-01 paso a paso"
                        ‚Ä¢ "Configuraci√≥n de gateway para c√°mara 10.41.25.100"
                        ‚Ä¢ "Ense√±ar c√≥mo acceder al switch del sitio OCO-02"
                        
                        ¬øEn qu√© puedo ayudarte hoy?
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 1.5rem;">
                <h4 style="font-size: 0.875rem; font-weight: 600; color: #6b7280; margin-bottom: 0.75rem;">Sugerencias r√°pidas</h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                    <button onclick="askAI('¬øCu√°ntas LPR en Santa Rosa de Cop√°n?')" style="padding: 0.75rem; border-radius: 0.5rem; font-size: 0.875rem; text-align: left; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.15) 100%); border: none; cursor: pointer; transition: all 0.3s;">
                        <i class="fas fa-car" style="color: #3b82f6; margin-right: 0.5rem;"></i>Contar LPR
                    </button>
                    <button onclick="askAI('C√≥mo conectarse al sitio SRC-01 paso a paso')" style="padding: 0.75rem; border-radius: 0.5rem; font-size: 0.875rem; text-align: left; background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.15) 100%); border: none; cursor: pointer; transition: all 0.3s;">
                        <i class="fas fa-plug" style="color: #ef4444; margin-right: 0.5rem;"></i>Conexi√≥n Sitio
                    </button>
                    <button onclick="askAI('Configuraci√≥n de red gateway puerta de enlace')" style="padding: 0.75rem; border-radius: 0.5rem; font-size: 0.875rem; text-align: left; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.15) 100%); border: none; cursor: pointer; transition: all 0.3s;">
                        <i class="fas fa-network-wired" style="color: #10b981; margin-right: 0.5rem;"></i>Config Red
                    </button>
                    <button onclick="askAI('Ense√±ar c√≥mo acceder al switch 10.41.25.254')" style="padding: 0.75rem; border-radius: 0.5rem; font-size: 0.875rem; text-align: left; background: linear-gradient(135deg, rgba(147, 51, 234, 0.1) 0%, rgba(147, 51, 234, 0.15) 100%); border: none; cursor: pointer; transition: all 0.3s;">
                        <i class="fas fa-graduation-cap" style="color: #8b5cf6; margin-right: 0.5rem;"></i>Ense√±ar IA
                    </button>
                </div>
            </div>
            
            <div style="margin-top: auto;">
                <div style="position: relative;">
                    <input type="text" id="ai-input" placeholder="Escribe tu pregunta..." style="width: 100%; padding: 1rem 3rem 1rem 1rem; border-radius: 0.75rem; border: 1px solid #d1d5db;">
                    <button id="send-ai-btn" onclick="sendAIQuestion()" style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s;">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.75rem; font-size: 0.75rem; color: #9ca3af;">
                    <span id="token-info">Contexto: 0 c√°maras</span>
                    <button onclick="clearChat()" style="background: none; border: none; color: #9ca3af; cursor: pointer; transition: color 0.3s;">
                        <i class="fas fa-trash-alt" style="margin-right: 0.25rem;"></i>Limpiar chat
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Editar/Nueva C√°mara -->
    <div id="edit-modal" class="modal-overlay" style="display: none; position: fixed; inset: 0; z-index: 50; align-items: center; justify-content: center; padding: 1rem;">
        <div class="modal-content" style="background: white; border-radius: 1rem; width: 100%; max-width: 42rem; max-height: 90vh; overflow-y: auto;">
            <div style="padding: 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 1rem 1rem 0 0;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="font-size: 1.25rem; font-weight: 700;" id="modal-title">Editar C√°mara</h3>
                    <button onclick="closeModal()" style="padding: 0.5rem; background: rgba(255, 255, 255, 0.2); border: none; border-radius: 50%; cursor: pointer; transition: all 0.3s; color: white;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div style="padding: 1.5rem;">
                <form id="camera-form" onsubmit="event.preventDefault(); saveCamera();">
                    <input type="hidden" id="camera-id">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                        <div>
                            <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">C√≥digo</label>
                            <input type="text" id="camera-code" required style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #d1d5db;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Tipo</label>
                            <select id="camera-type" style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #d1d5db;">
                                <option value="F1">F1 - Fija HD</option>
                                <option value="F2">F2 - Fija 4K</option>
                                <option value="F3">F3 - Fija 360¬∞</option>
                                <option value="P1">P1 - PTZ Motorizada</option>
                                <option value="L1">L1 - LPR</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Departamento</label>
                            <select id="camera-dept" style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #d1d5db;">
                                <option value="Cop√°n">Cop√°n</option>
                                <option value="Lempira">Lempira</option>
                                <option value="Ocotepeque">Ocotepeque</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Municipio</label>
                            <select id="camera-mun" style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #d1d5db;">
                                <!-- Se llena din√°micamente seg√∫n departamento -->
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Sitio <span style="color: #ef4444;">*</span></label>
                            <input type="text" id="camera-sitio" required placeholder="Ej: SRC-01" style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #d1d5db;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Direcci√≥n IP</label>
                            <input type="text" id="camera-ip" pattern="^(\d{1,3}\.){3}\d{1,3}$" placeholder="10.0.0.1" style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #d1d5db;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Estado</label>
                            <select id="camera-status" style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #d1d5db;">
                                <option value="active">Activa</option>
                                <option value="inactive">Inactiva</option>
                                <option value="maintenance">En mantenimiento</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Observaciones</label>
                        <textarea id="camera-notes" rows="3" style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #d1d5db;"></textarea>
                    </div>
                    <div style="display: flex; gap: 1rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb;">
                        <button type="submit" class="btn" style="flex: 1; background: linear-gradient(135deg, #10b981 0%, #34d399 100%); color: white;">
                            <i class="fas fa-save"></i>Guardar
                        </button>
                        <button type="button" onclick="closeModal()" class="btn" style="flex: 1; background: rgba(107, 114, 128, 0.1); color: #6b7280;">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal Detalles -->
    <div id="details-modal" class="modal-overlay" style="display: none; position: fixed; inset: 0; z-index: 50; align-items: center; justify-content: center; padding: 1rem;">
        <div class="modal-content" style="background: white; border-radius: 1rem; width: 100%; max-width: 48rem; max-height: 90vh; overflow-y: auto;"></div>
    </div>
    
    <!-- Modal Nuevo Sitio -->
    <div id="site-modal" class="modal-overlay" style="display: none; position: fixed; inset: 0; z-index: 50; align-items: center; justify-content: center; padding: 1rem;">
        <div class="modal-content" style="background: white; border-radius: 1rem; width: 100%; max-width: 42rem; padding: 2rem; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h3 style="font-size: 1.5rem; font-weight: 700; color: #1f2937;">Nuevo Sitio</h3>
                <button onclick="closeSiteModal()" style="padding: 0.75rem; background: #f3f4f6; border: none; border-radius: 0.75rem; cursor: pointer; transition: all 0.3s;">
                    <i class="fas fa-times" style="font-size: 1.25rem;"></i>
                </button>
            </div>
            <form id="site-form" onsubmit="event.preventDefault(); saveSite();">
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; color: #374151;">C√≥digo Sitio <span style="color: #ef4444;">*</span></label>
                    <input type="text" id="site-code" required placeholder="Ej: SRC-01, OCO-02" style="width: 100%; padding: 1rem; border-radius: 0.75rem; border: 1px solid #d1d5db;">
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div>
                        <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; color: #374151;">Departamento</label>
                        <select id="site-dept" style="width: 100%; padding: 1rem; border-radius: 0.75rem; border: 1px solid #d1d5db;">
                            <option value="Cop√°n">Cop√°n</option>
                            <option value="Lempira">Lempira</option>
                            <option value="Ocotepeque">Ocotepeque</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; color: #374151;">Municipio</label>
                        <select id="site-mun" style="width: 100%; padding: 1rem; border-radius: 0.75rem; border: 1px solid #d1d5db;">
                            <!-- Se llena din√°micamente seg√∫n departamento -->
                        </select>
                    </div>
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; color: #374151;">Direcci√≥n F√≠sica</label>
                    <textarea id="site-address" rows="3" placeholder="Calle, Av., referencias..." style="width: 100%; padding: 1rem; border-radius: 0.75rem; border: 1px solid #d1d5db;"></textarea>
                </div>
                <div style="display: flex; gap: 1rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb;">
                    <button type="submit" style="flex: 1; background: linear-gradient(135deg, #10b981 0%, #14b8a6 100%); color: white; padding: 1rem 1.5rem; border-radius: 0.75rem; font-weight: 600; border: none; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                        <i class="fas fa-save"></i>Guardar Sitio
                    </button>
                    <button type="button" onclick="closeSiteModal()" style="flex: 1; background: #e5e7eb; color: #1f2937; padding: 1rem 1.5rem; border-radius: 0.75rem; font-weight: 600; border: none; cursor: pointer; transition: all 0.3s;">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ==================== CONFIGURACI√ìN DEL SISTEMA ====================
        const SYSTEMCONFIG = {
            apiKey: 'sk-408c3a26f959433caccb8b561b61314f',
            endpoint: 'https://api.deepseek.com/v1/chat/completions',
            model: 'deepseek-chat',
            maxTokens: 2000,
            temperature: 0.7,
            useCorsProxy: true,
            corsProxyUrl: 'https://corsproxy.io/?'
        };

        const STORAGEKEYS = {
            CAMERAS: '911_cameras_v4',
            SITES: '911_sites_v4',
            SETTINGS: '911_settings_v4',
            AIHISTORY: '911_ai_history_v4',
            KNOWLEDGE_BASE: '911_knowledge_base_v4'
        };

        // ==================== VARIABLES GLOBALES ====================
        let camerasData = [];
        let sitesData = [];
        let filteredCameras = [];
        let aiHistory = [];
        let editMode = false;
        let currentFilter = 'all';
        let currentDeptFilter = 'all';
        let currentMunFilter = 'all';
        let currentSearchQuery = '';
        let listenersInitialized = false;

        // ==================== BASE DE CONOCIMIENTO DIN√ÅMICA ====================
        const knowledgeBase = {
            conexionesSitios: {},
            configuracionesEquipos: {},
            procedimientos: {},
            conocimientoAprendido: []
        };

        // ==================== ESTRUCTURA DE DATOS EDITABLE ====================
        let estructuraDatos = {
            departamentos: {
                "Cop√°n": {
                    totalCamaras: 421,
                    municipios: {
                        "Santa Rosa de Cop√°n": { camaras: 205, sitios: 56 },
                        "La Entrada": { camaras: 63, sitios: 32 },
                        "Cop√°n Ruinas": { camaras: 33, sitios: 12 },
                        "La Uni√≥n": { camaras: 14, sitios: 4 },
                        "Cucuyagua": { camaras: 21, sitios: 6 },
                        "San Pedro Cop√°n": { camaras: 7, sitios: 3 },
                        "Corqu√≠n": { camaras: 29, sitios: 8 },
                        "Florida": { camaras: 15, sitios: 5 },
                        "El Para√≠so": { camaras: 14, sitios: 6 }
                    }
                },
                "Lempira": {
                    totalCamaras: 47,
                    municipios: {
                        "Gracias Lempira": { camaras: 47, sitios: 18 }
                    }
                },
                "Ocotepeque": {
                    totalCamaras: 23,
                    municipios: {
                        "Ocotepeque": { camaras: 23, sitios: 8 }
                    }
                }
            },
            cascadas: {
                "CASCADA PRINCIPAL": { sitios: ["OCO-02", "OCO-03", "OCO-04"], principal: "OCO-02" },
                "SITIO √öNICO": { sitios: ["OCO-06"], principal: "OCO-06" },
                "Anillo 1.1": { sitios: ["SRC-02", "SRC-03", "SRC-04"], principal: "SRC-02" },
                "Anillo 4.1": { sitios: ["SRC-01", "SRC-05", "SRC-06"], principal: "SRC-01" }
            }
        };

        // ==================== FUNCIONES DE INICIALIZACI√ìN ====================
        function loadEstructuraDatos() {
            const saved = localStorage.getItem('estructura_datos_v2');
            if (saved) {
                try {
                    estructuraDatos = JSON.parse(saved);
                } catch (e) {
                    console.error('Error cargando estructura:', e);
                }
            }
        }

        function saveEstructuraDatos() {
            localStorage.setItem('estructura_datos_v2', JSON.stringify(estructuraDatos));
        }

        function loadKnowledgeBase() {
            const saved = localStorage.getItem(STORAGEKEYS.KNOWLEDGE_BASE);
            if (saved) {
                try {
                    const loaded = JSON.parse(saved);
                    Object.keys(loaded).forEach(key => {
                        if (knowledgeBase[key] !== undefined) {
                            knowledgeBase[key] = loaded[key];
                        }
                    });
                } catch (e) {
                    console.error('Error cargando base de conocimiento:', e);
                }
            }
        }

        function saveKnowledgeBase() {
            localStorage.setItem(STORAGEKEYS.KNOWLEDGE_BASE, JSON.stringify(knowledgeBase));
        }

        // ==================== INICIALIZACI√ìN DEL SISTEMA ====================
        document.addEventListener('DOMContentLoaded', function() {
            loadEstructuraDatos();
            loadKnowledgeBase();
            if (!listenersInitialized) {
                initEventListeners();
                listenersInitialized = true;
            }
            loadData();
            loadMapSettings();
            initSystem();
            updateTime();
            setInterval(updateTime, 60000);
            setInterval(updateMapTime, 30000);
        });

        function initEventListeners() {
            const sendBtn = document.getElementById('send-ai-btn');
            const aiInput = document.getElementById('ai-input');
            
            if (sendBtn) {
                sendBtn.addEventListener('click', sendAIQuestion);
            }
            
            if (aiInput) {
                aiInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        sendAIQuestion();
                    }
                });
            }
        }

        // ==================== GESTI√ìN DE DATOS ====================
        function loadData() {
            const savedCameras = localStorage.getItem(STORAGEKEYS.CAMERAS);
            if (savedCameras) {
                try {
                    camerasData = JSON.parse(savedCameras);
                } catch (e) {
                    console.error('Error loading cameras:', e);
                    camerasData = generateDefaultData();
                    saveData();
                }
            } else {
                camerasData = generateDefaultData();
                saveData();
            }
            
            const savedSites = localStorage.getItem(STORAGEKEYS.SITES);
            if (savedSites) {
                try {
                    sitesData = JSON.parse(savedSites);
                } catch (e) {
                    sitesData = [];
                }
            }
            
            const savedAIHistory = localStorage.getItem(STORAGEKEYS.AIHISTORY);
            if (savedAIHistory) {
                try {
                    aiHistory = JSON.parse(savedAIHistory);
                } catch (e) {
                    aiHistory = [];
                }
            }
            
            filteredCameras = [...camerasData];
            updateUI();
        }

        function saveData() {
            try {
                localStorage.setItem(STORAGEKEYS.CAMERAS, JSON.stringify(camerasData));
                localStorage.setItem(STORAGEKEYS.SITES, JSON.stringify(sitesData));
                localStorage.setItem(STORAGEKEYS.AIHISTORY, JSON.stringify(aiHistory));
            } catch (e) {
                console.error('Error saving data:', e);
                showNotification('Error al guardar datos', 'error');
            }
        }

        function generateDefaultData() {
            const datos = [];
            let id = 1;
            
            Object.entries(estructuraDatos.departamentos).forEach(([dept, infoDept]) => {
                Object.entries(infoDept.municipios).forEach(([municipio, infoMun]) => {
                    const numCameras = Math.min(infoMun.camaras, 30);
                    
                    for (let i = 1; i <= numCameras; i++) {
                        const siteNum = Math.ceil(i / Math.ceil(numCameras / infoMun.sitios));
                        const sitio = municipio.substring(0, 3).toUpperCase() + '-' + String(siteNum).padStart(2, '0');
                        const baseIP = `10.41.${Math.floor(Math.random() * 30) + 1}.${Math.floor(Math.random() * 200) + 10}`;
                        
                        let cascada = '';
                        Object.entries(estructuraDatos.cascadas).forEach(([nombre, info]) => {
                            if (info.sitios.includes(sitio)) {
                                cascada = nombre;
                            }
                        });
                        
                        const estadoRand = Math.random();
                        let estado = 'active';
                        if (estadoRand > 0.85) estado = 'inactive';
                        else if (estadoRand > 0.80) estado = 'maintenance';
                        
                        datos.push({
                            id: id++,
                            code: `CAM-${String(id).padStart(4, '0')}`,
                            tipo: ['F1','F2','F3','P1','L1'][Math.floor(Math.random() * 5)],
                            departamento: dept,
                            municipio: municipio,
                            sitio: sitio,
                            ip: baseIP,
                            gateway: baseIP.substring(0, baseIP.lastIndexOf('.') + 1) + '1',
                            switch: baseIP.substring(0, baseIP.lastIndexOf('.') + 1) + '254',
                            direccion: `Ubicaci√≥n ${i} en ${municipio}`,
                            lat: (14 + Math.random() * 2).toFixed(6),
                            lng: (-89 + Math.random() * 2).toFixed(6),
                            estado: estado,
                            cascada: cascada,
                            observaciones: Math.random() > 0.7 ? 'Requiere revisi√≥n peri√≥dica' : '',
                            fechainstalacion: new Date(2023, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1).toISOString().split('T')[0],
                            ultimarevision: new Date(2024, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1).toISOString().split('T')[0]
                        });
                    }
                });
            });
            
            return datos;
        }

        // ==================== ACTUALIZACI√ìN DE INTERFAZ ====================
        function updateUI() {
            updateStats();
            updateCounters();
            renderCameras();
        }

        function updateStats() {
            const total = camerasData.length;
            const active = camerasData.filter(c => c.estado === 'active').length;
            const inactive = camerasData.filter(c => c.estado === 'inactive').length;
            const maintenance = camerasData.filter(c => c.estado === 'maintenance').length;
            const cascadas = Object.keys(estructuraDatos.cascadas).length;
            
            document.getElementById('total-cameras').textContent = total;
            document.getElementById('active-cameras').textContent = active;
            document.getElementById('inactive-cameras').textContent = inactive;
            document.getElementById('maintenance-cameras').textContent = maintenance;
            document.getElementById('cascadas-count').textContent = cascadas;
        }

        function updateCounters() {
            const filteredCount = filteredCameras.length;
            const activeCount = filteredCameras.filter(c => c.estado === 'active').length;
            const inactiveCount = filteredCameras.filter(c => c.estado === 'inactive').length;
            
            document.getElementById('total-count').textContent = filteredCount;
            document.getElementById('active-count').textContent = activeCount;
            document.getElementById('inactive-count').textContent = inactiveCount;
        }

        function renderCameras() {
            const container = document.getElementById('cameras-list');
            if (!container) return;
            
            container.innerHTML = '';
            
            const camerasToShow = filteredCameras.slice(0, 12);
            
            camerasToShow.forEach(camera => {
                const card = document.createElement('div');
                card.className = `camera-card ${camera.estado} fade-in`;
                
                let statusText = 'Activa';
                let statusClass = 'status-active';
                if (camera.estado === 'inactive') {
                    statusText = 'Inactiva';
                    statusClass = 'status-inactive';
                } else if (camera.estado === 'maintenance') {
                    statusText = 'Mantenimiento';
                    statusClass = 'status-maintenance';
                }
                
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                        <div>
                            <h4 style="font-weight: 700; font-size: 1.125rem; margin-bottom: 0.5rem;">${camera.code}</h4>
                            <span class="status-badge ${statusClass}">
                                <i class="fas fa-circle" style="font-size: 0.625rem;"></i>
                                ${statusText}
                            </span>
                        </div>
                        ${editMode ? `
                            <button onclick="editCamera(${camera.id})" style="padding: 0.5rem; background: #f3f4f6; border: none; border-radius: 0.5rem; cursor: pointer;">
                                <i class="fas fa-edit" style="color: #6b7280;"></i>
                            </button>
                        ` : ''}
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.875rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-map-marker-alt" style="color: #9ca3af;"></i>
                            <span>${camera.municipio}, ${camera.departamento}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-network-wired" style="color: #9ca3af;"></i>
                            <span>${camera.ip}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-video" style="color: #9ca3af;"></i>
                            <span>Tipo: ${camera.tipo}</span>
                        </div>
                        ${camera.sitio ? `
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-building" style="color: #9ca3af;"></i>
                                <span>Sitio: ${camera.sitio}</span>
                            </div>
                        ` : ''}
                        ${camera.cascada ? `
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-project-diagram" style="color: #9ca3af;"></i>
                                <span>${camera.cascada}</span>
                            </div>
                        ` : ''}
                    </div>
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                        <button onclick="viewDetails(${camera.id})" style="width: 100%; padding: 0.5rem 1rem; border-radius: 0.5rem; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.15) 100%); color: #3b82f6; border: none; cursor: pointer; font-weight: 500; transition: all 0.3s;">
                            Ver detalles
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
            
            if (filteredCameras.length > 12) {
                const moreCard = document.createElement('div');
                moreCard.className = 'camera-card';
                moreCard.style.borderLeft = '4px solid #9ca3af';
                moreCard.style.textAlign = 'center';
                moreCard.style.padding = '2rem';
                moreCard.innerHTML = `
                    <div style="color: #6b7280; margin-bottom: 0.75rem;">
                        <i class="fas fa-ellipsis-h" style="font-size: 1.5rem;"></i>
                    </div>
                    <p style="font-weight: 600;">${filteredCameras.length - 12} c√°maras m√°s</p>
                    <p style="font-size: 0.875rem; color: #9ca3af; margin-top: 0.5rem;">Usa los filtros para refinar la b√∫squeda</p>
                `;
                container.appendChild(moreCard);
            }
            
            if (filteredCameras.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: #6b7280;">
                        <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p style="font-size: 1.125rem; font-weight: 600;">No se encontraron c√°maras</p>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">Intenta ajustar los filtros de b√∫squeda</p>
                    </div>
                `;
            }
        }

        // ==================== SISTEMA DE FILTROS JER√ÅRQUICO ====================
        function filterByStatus(status) {
            currentFilter = status;
            applyAllFilters();
        }

        function loadDeptFilterOptions() {
            const deptSelect = document.getElementById('filter-dept');
            if (!deptSelect) return;
            
            const currentValue = deptSelect.value;
            
            deptSelect.innerHTML = '<option value="all">Todos los departamentos</option>';
            
            Object.keys(estructuraDatos.departamentos).forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                deptSelect.appendChild(option);
            });
            
            if (currentValue && Array.from(deptSelect.options).some(opt => opt.value === currentValue)) {
                deptSelect.value = currentValue;
            } else {
                deptSelect.value = 'all';
            }
        }

        function loadMunFilterOptions(dept) {
            const munSelect = document.getElementById('filter-mun');
            if (!munSelect) return;
            
            const currentValue = munSelect.value;
            
            munSelect.innerHTML = '<option value="all">Todos los municipios</option>';
            
            if (dept && dept !== 'all') {
                munSelect.disabled = false;
                
                const municipios = estructuraDatos.departamentos[dept]?.municipios;
                if (municipios) {
                    Object.keys(municipios).forEach(mun => {
                        const option = document.createElement('option');
                        option.value = mun;
                        option.textContent = mun;
                        munSelect.appendChild(option);
                    });
                }
            } else {
                munSelect.disabled = true;
                munSelect.value = 'all';
            }
            
            if (!munSelect.disabled && currentValue && Array.from(munSelect.options).some(opt => opt.value === currentValue)) {
                munSelect.value = currentValue;
            } else {
                munSelect.value = 'all';
            }
        }

        function onDeptFilterChange(dept) {
            currentDeptFilter = dept;
            currentMunFilter = 'all';
            loadMunFilterOptions(dept);
            applyAllFilters();
        }

        function onMunFilterChange(mun) {
            currentMunFilter = mun;
            applyAllFilters();
        }

        let searchTimeout;
        function searchCameras(query) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentSearchQuery = query;
                applyAllFilters();
                
                if (filteredCameras.length === 0) {
                    showNotification(`No se encontraron resultados para "${query}"`, 'info');
                }
            }, 300);
        }

        function applyAllFilters() {
            let result = camerasData;
            
            if (currentFilter !== 'all') {
                result = result.filter(c => c.estado === currentFilter);
            }
            
            if (currentDeptFilter !== 'all') {
                result = result.filter(c => c.departamento === currentDeptFilter);
            }
            
            if (currentMunFilter !== 'all') {
                result = result.filter(c => c.municipio === currentMunFilter);
            }
            
            if (currentSearchQuery.trim() !== '') {
                const query = currentSearchQuery.toLowerCase().trim();
                result = result.filter(c => 
                    c.code.toLowerCase().includes(query) ||
                    c.ip.toLowerCase().includes(query) ||
                    c.municipio.toLowerCase().includes(query) ||
                    c.departamento.toLowerCase().includes(query) ||
                    (c.sitio && c.sitio.toLowerCase().includes(query)) ||
                    (c.cascada && c.cascada.toLowerCase().includes(query)) ||
                    (c.tipo && c.tipo.toLowerCase().includes(query)) ||
                    (c.observaciones && c.observaciones.toLowerCase().includes(query))
                );
            }
            
            filteredCameras = result;
            renderCameras();
            updateCounters();
        }

        // ==================== GESTI√ìN DE C√ÅMARAS ====================
        function addNewCamera() {
            document.getElementById('modal-title').textContent = 'Nueva C√°mara';
            document.getElementById('camera-id').value = '';
            document.getElementById('camera-form').reset();
            
            const newId = camerasData.length ? Math.max(...camerasData.map(c => c.id)) + 1 : 1000;
            document.getElementById('camera-code').value = `CAM-${String(newId).padStart(4, '0')}`;
            
            updateMunicipioSelect('camera-dept', 'camera-mun');
            
            document.getElementById('edit-modal').style.display = 'flex';
        }

        function editCamera(id) {
            const camera = camerasData.find(c => c.id == id);
            if (!camera) return;
            
            document.getElementById('modal-title').textContent = 'Editar C√°mara';
            document.getElementById('camera-id').value = camera.id;
            document.getElementById('camera-code').value = camera.code;
            document.getElementById('camera-type').value = camera.tipo;
            document.getElementById('camera-dept').value = camera.departamento;
            document.getElementById('camera-sitio').value = camera.sitio || '';
            document.getElementById('camera-ip').value = camera.ip;
            document.getElementById('camera-status').value = camera.estado;
            document.getElementById('camera-notes').value = camera.observaciones || '';
            
            updateMunicipioSelect('camera-dept', 'camera-mun', camera.municipio);
            
            document.getElementById('edit-modal').style.display = 'flex';
        }

        function updateMunicipioSelect(deptSelectId, munSelectId, selectedMun = '') {
            const deptSelect = document.getElementById(deptSelectId);
            const munSelect = document.getElementById(munSelectId);
            const dept = deptSelect.value;
            
            const currentValue = munSelect.value;
            munSelect.innerHTML = '';
            
            if (dept && estructuraDatos.departamentos[dept]) {
                const municipios = Object.keys(estructuraDatos.departamentos[dept].municipios);
                
                municipios.forEach(mun => {
                    const option = document.createElement('option');
                    option.value = mun;
                    option.textContent = mun;
                    if (mun === selectedMun) option.selected = true;
                    munSelect.appendChild(option);
                });
                
                if (!selectedMun && currentValue && municipios.includes(currentValue)) {
                    munSelect.value = currentValue;
                }
            }
        }

        function isValidIP(ip) {
            const pattern = /^(\d{1,3}\.){3}\d{1,3}$/;
            if (!pattern.test(ip)) return false;
            
            const parts = ip.split('.');
            return parts.every(part => {
                const num = parseInt(part, 10);
                return num >= 0 && num <= 255;
            });
        }

        function validateCameraData() {
            const sitio = document.getElementById('camera-sitio').value.trim();
            const ip = document.getElementById('camera-ip').value.trim();
            const code = document.getElementById('camera-code').value.trim();
            
            if (!sitio) {
                showNotification('‚ö†Ô∏è El campo Sitio es obligatorio', 'error');
                document.getElementById('camera-sitio').focus();
                return false;
            }
            
            if (ip && !isValidIP(ip)) {
                showNotification('‚ö†Ô∏è Formato de IP inv√°lido', 'error');
                document.getElementById('camera-ip').focus();
                return false;
            }
            
            if (!code) {
                showNotification('‚ö†Ô∏è El c√≥digo de c√°mara es obligatorio', 'error');
                document.getElementById('camera-code').focus();
                return false;
            }
            
            const sitioPattern = /^[A-Z]{3}-\d{2}$/;
            if (!sitioPattern.test(sitio)) {
                const confirm = window.confirm(
                    `El formato del sitio "${sitio}" no es est√°ndar (ej: SRC-01).\n¬øDeseas continuar de todos modos?`
                );
                if (!confirm) return false;
            }
            
            return true;
        }

        function saveCamera() {
            if (!validateCameraData()) {
                return;
            }
            
            const id = document.getElementById('camera-id').value;
            
            const cameraData = {
                code: document.getElementById('camera-code').value.trim(),
                tipo: document.getElementById('camera-type').value,
                departamento: document.getElementById('camera-dept').value,
                municipio: document.getElementById('camera-mun').value,
                sitio: document.getElementById('camera-sitio').value.trim().toUpperCase(),
                ip: document.getElementById('camera-ip').value.trim(),
                estado: document.getElementById('camera-status').value,
                observaciones: document.getElementById('camera-notes').value.trim(),
                ultimaactualizacion: new Date().toISOString().split('T')[0]
            };

            if (id) {
                const index = camerasData.findIndex(c => c.id == id);
                if (index !== -1) {
                    camerasData[index] = { ...camerasData[index], ...cameraData };
                    showNotification('‚úÖ C√°mara actualizada exitosamente', 'success');
                }
            } else {
                const newId = camerasData.length ? Math.max(...camerasData.map(c => c.id)) + 1 : 1000;
                cameraData.id = newId;
                cameraData.lat = (14 + Math.random() * 2).toFixed(6);
                cameraData.lng = (-89 + Math.random() * 2).toFixed(6);
                cameraData.gateway = cameraData.ip ? cameraData.ip.substring(0, cameraData.ip.lastIndexOf('.') + 1) + '1' : '10.0.0.1';
                cameraData.switch = cameraData.ip ? cameraData.ip.substring(0, cameraData.ip.lastIndexOf('.') + 1) + '254' : '10.0.0.254';
                cameraData.fechainstalacion = new Date().toISOString().split('T')[0];
                camerasData.push(cameraData);
                showNotification('‚úÖ C√°mara creada exitosamente', 'success');
            }

            saveData();
            applyAllFilters();
            closeModal();
        }

        function viewDetails(id) {
            const camera = camerasData.find(c => c.id == id);
            if (!camera) return;

            const modal = document.getElementById('details-modal');
            const container = modal.querySelector('.modal-content');
            
            let statusText = 'Activa';
            let statusClass = 'status-active';
            if (camera.estado === 'inactive') {
                statusText = 'Inactiva';
                statusClass = 'status-inactive';
            } else if (camera.estado === 'maintenance') {
                statusText = 'Mantenimiento';
                statusClass = 'status-maintenance';
            }
            
            const infoConexion = knowledgeBase.conexionesSitios[camera.sitio] || 
                                knowledgeBase.conexionesSitios[camera.code] || 
                                null;
            
            container.innerHTML = `
                <div style="padding: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h3 style="font-size: 1.5rem; font-weight: 700; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                            Detalles: ${camera.code}
                        </h3>
                        <button onclick="closeDetailsModal()" style="padding: 0.75rem; background: #f3f4f6; border: none; border-radius: 0.75rem; cursor: pointer; transition: all 0.3s;">
                            <i class="fas fa-times" style="font-size: 1.25rem;"></i>
                        </button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                        <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(99, 102, 241, 0.1) 100%); border-radius: 1rem;">
                            <h4 style="font-weight: 700; font-size: 1.125rem; margin-bottom: 1rem;">
                                <i class="fas fa-info-circle" style="color: #3b82f6; margin-right: 0.5rem;"></i>Informaci√≥n B√°sica
                            </h4>
                            <div style="display: flex; flex-direction: column; gap: 0.75rem; font-size: 0.875rem;">
                                <div><strong>C√≥digo:</strong> ${camera.code}</div>
                                <div><strong>Sitio:</strong> ${camera.sitio || 'N/A'}</div>
                                <div><strong>Tipo:</strong> ${camera.tipo}</div>
                                <div>
                                    <strong>Estado:</strong> 
                                    <span class="status-badge ${statusClass}" style="margin-left: 0.5rem;">
                                        ${statusText}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(52, 211, 153, 0.1) 100%); border-radius: 1rem;">
                            <h4 style="font-weight: 700; font-size: 1.125rem; margin-bottom: 1rem;">
                                <i class="fas fa-network-wired" style="color: #10b981; margin-right: 0.5rem;"></i>Configuraci√≥n de Red
                            </h4>
                            <div style="display: flex; flex-direction: column; gap: 0.75rem; font-size: 0.875rem;">
                                <div><strong>IP:</strong> ${camera.ip}</div>
                                <div><strong>Gateway:</strong> ${camera.gateway || '10.0.0.1'}</div>
                                <div><strong>Switch:</strong> ${camera.switch || '10.0.0.254'}</div>
                                <div><strong>M√°scara:</strong> 255.255.255.0</div>
                            </div>
                        </div>
                        
                        <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(147, 51, 234, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%); border-radius: 1rem;">
                            <h4 style="font-weight: 700; font-size: 1.125rem; margin-bottom: 1rem;">
                                <i class="fas fa-map-marker-alt" style="color: #8b5cf6; margin-right: 0.5rem;"></i>Ubicaci√≥n
                            </h4>
                            <p style="font-size: 1.125rem; font-weight: 600;">${camera.municipio}, ${camera.departamento}</p>
                            <p style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">
                                Lat: ${camera.lat || 'N/A'}, Lng: ${camera.lng || 'N/A'}
                            </p>
                        </div>
                        
                        ${camera.cascada ? `
                        <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(251, 191, 36, 0.1) 100%); border-radius: 1rem;">
                            <h4 style="font-weight: 700; font-size: 1.125rem; margin-bottom: 1rem;">
                                <i class="fas fa-project-diagram" style="color: #f59e0b; margin-right: 0.5rem;"></i>Cascada
                            </h4>
                            <p style="font-size: 1.25rem; font-weight: 700;">${camera.cascada}</p>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(99, 102, 241, 0.05) 100%); border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem;">
                        <h4 style="font-weight: 700; font-size: 1.25rem; margin-bottom: 1rem; color: #3b82f6;">
                            <i class="fas fa-plug" style="margin-right: 0.5rem;"></i>Gu√≠a de Conexi√≥n
                        </h4>
                        
                        ${infoConexion ? `
                            <div style="margin-bottom: 1rem;">
                                <h5 style="font-weight: 600; color: #10b981; margin-bottom: 0.5rem;">
                                    <i class="fas fa-check-circle"></i> Informaci√≥n de conexi√≥n disponible
                                </h5>
                                <p>Hay informaci√≥n guardada para este sitio. Pregunta al asistente: "¬øC√≥mo conectarse a ${camera.sitio || camera.code}?"</p>
                            </div>
                        ` : ''}
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                            <div style="background: white; border-radius: 0.75rem; padding: 1rem; border: 1px solid #e5e7eb;">
                                <h5 style="font-weight: 600; margin-bottom: 0.75rem; color: #374151;">
                                    <i class="fas fa-bolt" style="color: #f59e0b; margin-right: 0.5rem;"></i>Acceso R√°pido
                                </h5>
                                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                    <button onclick="copiarAlPortapapeles('http://${camera.ip}')" style="text-align: left; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #d1d5db; background: white; cursor: pointer;">
                                        <i class="fas fa-globe" style="color: #3b82f6;"></i> Web: http://${camera.ip}
                                    </button>
                                    <button onclick="copiarAlPortapapeles('ssh tecnico@${camera.ip}')" style="text-align: left; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #d1d5db; background: white; cursor: pointer;">
                                        <i class="fas fa-terminal" style="color: #10b981;"></i> SSH: tecnico@${camera.ip}
                                    </button>
                                    <button onclick="copiarAlPortapapeles('ping ${camera.ip}')" style="text-align: left; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #d1d5db; background: white; cursor: pointer;">
                                        <i class="fas fa-satellite-dish" style="color: #8b5cf6;"></i> Ping: ${camera.ip}
                                    </button>
                                </div>
                            </div>
                            
                            <div style="background: white; border-radius: 0.75rem; padding: 1rem; border: 1px solid #e5e7eb;">
                                <h5 style="font-weight: 600; margin-bottom: 0.75rem; color: #374151;">
                                    <i class="fas fa-key" style="color: #ef4444; margin-right: 0.5rem;"></i>Credenciales
                                </h5>
                                <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.875rem;">
                                    <div><strong>Usuario:</strong> admin</div>
                                    <div><strong>Contrase√±a:</strong> admin123</div>
                                    <div><strong>Protocolo:</strong> ONVIF</div>
                                    <div><strong>Puerto:</strong> 80</div>
                                </div>
                            </div>
                            
                            <div style="background: white; border-radius: 0.75rem; padding: 1rem; border: 1px solid #e5e7eb;">
                                <h5 style="font-weight: 600; margin-bottom: 0.75rem; color: #374151;">
                                    <i class="fas fa-tools" style="color: #667eea; margin-right: 0.5rem;"></i>Acciones
                                </h5>
                                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                    <button onclick="askAI('¬øC√≥mo conectarse a ${camera.sitio || camera.code}?')" style="padding: 0.5rem; border-radius: 0.5rem; background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: none; cursor: pointer;">
                                        <i class="fas fa-robot"></i> Pedir gu√≠a de conexi√≥n
                                    </button>
                                    <button onclick="askAI('Aprende c√≥mo conectarse a ${camera.sitio || camera.code}')" style="padding: 0.5rem; border-radius: 0.5rem; background: rgba(16, 185, 129, 0.1); color: #10b981; border: none; cursor: pointer;">
                                        <i class="fas fa-graduation-cap"></i> Ense√±ar conexi√≥n
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${camera.observaciones ? `
                    <div style="padding: 1.5rem; background: #f9fafb; border-radius: 1rem; margin-bottom: 2rem;">
                        <h4 style="font-weight: 700; font-size: 1.125rem; margin-bottom: 1rem;">
                            <i class="fas fa-sticky-note" style="color: #6b7280; margin-right: 0.5rem;"></i>Observaciones
                        </h4>
                        <p style="white-space: pre-wrap;">${camera.observaciones}</p>
                    </div>
                    ` : ''}
                    
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button onclick="editCamera(${camera.id}); closeDetailsModal();" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%); color: white; padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: 600; border: none; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <i class="fas fa-edit"></i>Editar C√°mara
                        </button>
                        <button onclick="askAI('Configuraci√≥n de red para ${camera.ip}')" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #10b981 0%, #14b8a6 100%); color: white; padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: 600; border: none; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <i class="fas fa-network-wired"></i>Configuraci√≥n de Red
                        </button>
                        <button onclick="deleteCamera(${camera.id})" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #ef4444 0%, #f87171 100%); color: white; padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: 600; border: none; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <i class="fas fa-trash"></i>Eliminar
                        </button>
                    </div>
                </div>
            `;
            modal.style.display = 'flex';
        }

        function closeDetailsModal() {
            document.getElementById('details-modal').style.display = 'none';
        }

        function deleteCamera(id) {
            if (confirm('¬øEst√°s seguro de eliminar esta c√°mara? Esta acci√≥n no se puede deshacer.')) {
                camerasData = camerasData.filter(c => c.id != id);
                saveData();
                applyAllFilters();
                closeDetailsModal();
                showNotification('üóëÔ∏è C√°mara eliminada correctamente', 'success');
            }
        }

        function closeModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        // ==================== GESTI√ìN DE SITIOS ====================
        function showSiteModal() {
            document.getElementById('site-modal').style.display = 'flex';
            document.getElementById('site-code').focus();
            
            updateMunicipioSelect('site-dept', 'site-mun');
        }

        function closeSiteModal() {
            document.getElementById('site-modal').style.display = 'none';
            document.getElementById('site-form').reset();
        }

        function saveSite() {
            const siteData = {
                id: Date.now(),
                code: document.getElementById('site-code').value.trim(),
                departamento: document.getElementById('site-dept').value,
                municipio: document.getElementById('site-mun').value,
                direccion: document.getElementById('site-address').value.trim(),
                camarasAsignadas: [],
                fechaCreacion: new Date().toISOString().split('T')[0]
            };
            
            if (!siteData.code) {
                showNotification('‚ö†Ô∏è El c√≥digo del sitio es obligatorio', 'error');
                return;
            }
            
            const exists = sitesData.some(s => s.code === siteData.code);
            if (exists) {
                showNotification('‚ö†Ô∏è Ya existe un sitio con este c√≥digo', 'error');
                return;
            }
            
            sitesData.push(siteData);
            saveData();
            closeSiteModal();
            showNotification('‚úÖ Sitio creado exitosamente', 'success');
        }

        // ==================== SISTEMA DE AN√ÅLISIS DE LENGUAJE NATURAL ====================
        class AnalizadorConsultas {
            static analizar(consulta) {
                const consultaLower = consulta.toLowerCase();
                const palabras = consultaLower.split(' ');
                
                return {
                    tipo: this.detectarTipoConsulta(consulta, consultaLower, palabras),
                    parametros: this.extraerParametros(consulta, consultaLower),
                    contexto: this.detectarContexto(consultaLower),
                    urgencia: this.detectarUrgencia(consultaLower)
                };
            }

            static detectarTipoConsulta(consulta, consultaLower, palabras) {
                if (/(cu√°ntas|cuantos|total de).*lpr/i.test(consulta)) return 'contar_lpr';
                if (/(cu√°ntas|cuantos|total de).*c√°maras|camaras/i.test(consulta)) return 'contar_camaras';
                if (/c√°mara.*(\d{1,3}\.){3}\d{1,3}/i.test(consulta)) return 'info_ip';
                if (/conectarse|conectar|acceder|configurar.*(sitio|c√°mara|camara|switch)/i.test(consulta)) return 'conexion';
                if (/(ip|gateway|puerta de enlace).*(c√°mara|camara|sitio)/i.test(consulta)) return 'config_red';
                if (/paso a paso|instrucciones|procedimiento/i.test(consulta)) return 'procedimiento';
                if (/agregar|a√±adir|ense√±ar|aprender/i.test(consulta)) return 'aprendizaje';
                if (/problema|error|falla|no funciona/i.test(consulta)) return 'soporte';
                if (/estad√≠stica|reporte|resumen/i.test(consulta)) return 'reporte';
                
                return 'general';
            }

            static extraerParametros(consulta, consultaLower) {
                const parametros = {
                    ciudad: null,
                    departamento: null,
                    sitio: null,
                    tipoCamara: null,
                    ip: null,
                    codigo: null
                };

                const ipMatch = consulta.match(/(\d{1,3}\.){3}\d{1,3}/);
                if (ipMatch) parametros.ip = ipMatch[0];

                if (consultaLower.includes('lpr')) parametros.tipoCamara = 'LPR';
                else if (consultaLower.includes('ptz')) parametros.tipoCamara = 'PTZ';
                else if (consultaLower.includes('fija')) parametros.tipoCamara = 'FIJA';

                const codigoMatch = consulta.match(/([A-Z]{3,4}-\d{3,4}|[A-Z]{3}-\d{2})/);
                if (codigoMatch) parametros.codigo = codigoMatch[0];

                Object.keys(estructuraDatos.departamentos).forEach(depto => {
                    if (consultaLower.includes(depto.toLowerCase())) {
                        parametros.departamento = depto;
                        
                        Object.keys(estructuraDatos.departamentos[depto].municipios).forEach(mun => {
                            if (consultaLower.includes(mun.toLowerCase())) {
                                parametros.ciudad = mun;
                            }
                        });
                    }
                });

                return parametros;
            }

            static detectarContexto(consultaLower) {
                if (consultaLower.includes('t√©cnico') || consultaLower.includes('tecnico')) return 'tecnico';
                if (consultaLower.includes('administrador') || consultaLower.includes('admin')) return 'administrador';
                if (consultaLower.includes('operador') || consultaLower.includes('usuario')) return 'operador';
                return 'general';
            }

            static detectarUrgencia(consultaLower) {
                if (/(urgente|emergencia|cr√≠tico|critico|inmediato)/i.test(consultaLower)) return 'alta';
                if (/(importante|prioridad|atenci√≥n|atencion)/i.test(consultaLower)) return 'media';
                return 'baja';
            }
        }

        // ==================== SISTEMA DE RESPUESTAS INTELIGENTES ====================
        class GeneradorRespuestasIA {
            static generarRespuesta(consulta, analisis) {
                switch(analisis.tipo) {
                    case 'contar_lpr':
                        return this.contarLPR(analisis.parametros);
                    case 'contar_camaras':
                        return this.contarCamaras(analisis.parametros);
                    case 'info_ip':
                        return this.infoPorIP(analisis.parametros);
                    case 'conexion':
                        return this.guiaConexion(analisis.parametros, consulta);
                    case 'config_red':
                        return this.configuracionRed(analisis.parametros);
                    case 'procedimiento':
                        return this.procedimientoDetallado(analisis.parametros, consulta);
                    case 'aprendizaje':
                        return this.aprenderNuevaInfo(consulta);
                    case 'soporte':
                        return this.soporteTecnico(consulta);
                    case 'reporte':
                        return this.generarReporte(analisis.parametros);
                    default:
                        return this.respuestaGeneral(consulta, analisis);
                }
            }

            static contarLPR(parametros) {
                const lprCameras = camerasData.filter(c => c.tipo === 'L1');
                
                if (parametros.departamento || parametros.ciudad || parametros.sitio) {
                    let filtradas = lprCameras;
                    
                    if (parametros.departamento) {
                        filtradas = filtradas.filter(c => c.departamento === parametros.departamento);
                    }
                    
                    if (parametros.ciudad) {
                        filtradas = filtradas.filter(c => c.municipio === parametros.ciudad);
                    }
                    
                    if (parametros.sitio) {
                        filtradas = filtradas.filter(c => c.sitio === parametros.sitio);
                    }
                    
                    const activas = filtradas.filter(c => c.estado === 'active').length;
                    const inactivas = filtradas.filter(c => c.estado === 'inactive').length;
                    const mantenimiento = filtradas.filter(c => c.estado === 'maintenance').length;
                    
                    let respuesta = `üìä **C√°maras LPR encontradas:**\n\n`;
                    respuesta += `üìç **Ubicaci√≥n:** ${parametros.departamento || 'Todos'} > ${parametros.ciudad || 'Todas'} > ${parametros.sitio || 'Todos'}\n`;
                    respuesta += `üî¢ **Total:** ${filtradas.length} c√°maras LPR\n`;
                    respuesta += `‚úÖ **Activas:** ${activas}\n`;
                    respuesta += `‚ö†Ô∏è **Inactivas:** ${inactivas}\n`;
                    respuesta += `üîß **En mantenimiento:** ${mantenimiento}\n\n`;
                    
                    if (filtradas.length > 0) {
                        respuesta += `**Lista de c√°maras LPR:**\n`;
                        filtradas.slice(0, 10).forEach(cam => {
                            respuesta += `‚Ä¢ ${cam.code} - ${cam.sitio || 'Sin sitio'} - ${cam.ip || 'Sin IP'} - ${cam.estado === 'active' ? '‚úÖ' : '‚ùå'}\n`;
                        });
                        
                        if (filtradas.length > 10) {
                            respuesta += `\n*... y ${filtradas.length - 10} m√°s*`;
                        }
                    }
                    
                    return respuesta;
                }
                
                const totalLPR = lprCameras.length;
                const activas = lprCameras.filter(c => c.estado === 'active').length;
                
                let respuesta = `üéØ **Sistema de C√°maras LPR (Reconocimiento de Placas)**\n\n`;
                respuesta += `üìà **Total en sistema:** ${totalLPR} c√°maras LPR\n`;
                respuesta += `‚úÖ **Activas:** ${activas} (${Math.round((activas/totalLPR)*100)}%)\n`;
                respuesta += `‚ö†Ô∏è **Inactivas:** ${totalLPR - activas}\n\n`;
                respuesta += `**Distribuci√≥n por departamento:**\n`;
                
                const porDepto = {};
                lprCameras.forEach(cam => {
                    if (!porDepto[cam.departamento]) porDepto[cam.departamento] = 0;
                    porDepto[cam.departamento]++;
                });
                
                Object.entries(porDepto).forEach(([depto, count]) => {
                    respuesta += `‚Ä¢ ${depto}: ${count} LPRs\n`;
                });
                
                respuesta += `\nüí° *Puedes preguntar por departamento espec√≠fico: "¬øCu√°ntas LPR en Cop√°n?"*`;
                
                return respuesta;
            }

            static contarCamaras(parametros) {
                let filtradas = camerasData;
                
                if (parametros.departamento) {
                    filtradas = filtradas.filter(c => c.departamento === parametros.departamento);
                }
                
                if (parametros.ciudad) {
                    filtradas = filtradas.filter(c => c.municipio === parametros.ciudad);
                }
                
                if (parametros.tipoCamara) {
                    const tipoMap = {
                        'LPR': 'L1',
                        'PTZ': 'P1',
                        'FIJA': ['F1', 'F2', 'F3']
                    };
                    
                    if (parametros.tipoCamara === 'FIJA') {
                        filtradas = filtradas.filter(c => ['F1', 'F2', 'F3'].includes(c.tipo));
                    } else {
                        filtradas = filtradas.filter(c => c.tipo === tipoMap[parametros.tipoCamara]);
                    }
                }
                
                const total = filtradas.length;
                const activas = filtradas.filter(c => c.estado === 'active').length;
                const inactivas = filtradas.filter(c => c.estado === 'inactive').length;
                const mantenimiento = filtradas.filter(c => c.estado === 'maintenance').length;
                
                let respuesta = `üìä **Informe de C√°maras**\n\n`;
                
                if (parametros.departamento || parametros.ciudad || parametros.tipoCamara) {
                    respuesta += `**Filtros aplicados:**\n`;
                    if (parametros.departamento) respuesta += `‚Ä¢ Departamento: ${parametros.departamento}\n`;
                    if (parametros.ciudad) respuesta += `‚Ä¢ Municipio: ${parametros.ciudad}\n`;
                    if (parametros.tipoCamara) respuesta += `‚Ä¢ Tipo: ${parametros.tipoCamara}\n`;
                    respuesta += `\n`;
                }
                
                respuesta += `üî¢ **Total:** ${total} c√°maras\n`;
                respuesta += `‚úÖ **Activas:** ${activas} (${total > 0 ? Math.round((activas/total)*100) : 0}%)\n`;
                respuesta += `‚ö†Ô∏è **Inactivas:** ${inactivas}\n`;
                respuesta += `üîß **En mantenimiento:** ${mantenimiento}\n\n`;
                
                const porTipo = {};
                filtradas.forEach(cam => {
                    let tipo = cam.tipo;
                    if (['F1', 'F2', 'F3'].includes(tipo)) tipo = 'Fija';
                    else if (tipo === 'P1') tipo = 'PTZ';
                    else if (tipo === 'L1') tipo = 'LPR';
                    
                    if (!porTipo[tipo]) porTipo[tipo] = 0;
                    porTipo[tipo]++;
                });
                
                respuesta += `**Distribuci√≥n por tipo:**\n`;
                Object.entries(porTipo).forEach(([tipo, count]) => {
                    respuesta += `‚Ä¢ ${tipo}: ${count}\n`;
                });
                
                return respuesta;
            }

            static guiaConexion(parametros, consultaOriginal) {
                const sitioKey = parametros.sitio || parametros.codigo || 'general';
                
                if (knowledgeBase.conexionesSitios[sitioKey]) {
                    return this.mostrarGuiaExistente(sitioKey, parametros);
                }
                
                return this.generarGuiaGenerica(parametros, consultaOriginal);
            }

            static mostrarGuiaExistente(sitioKey, parametros) {
                const guia = knowledgeBase.conexionesSitios[sitioKey];
                let respuesta = `üîå **Gu√≠a de Conexi√≥n para ${sitioKey}**\n\n`;
                
                respuesta += `üìã **Informaci√≥n guardada el:** ${guia.fechaActualizacion || 'Desconocida'}\n`;
                respuesta += `üë§ **Actualizado por:** ${guia.autor || 'Sistema'}\n\n`;
                
                respuesta += `### üîß **CONEXI√ìN AL SITIO**\n`;
                respuesta += `${guia.conexionSitio || 'No hay informaci√≥n espec√≠fica'}\n\n`;
                
                respuesta += `### üìπ **CONEXI√ìN A C√ÅMARAS**\n`;
                respuesta += `${guia.conexionCamaras || 'No hay informaci√≥n espec√≠fica'}\n\n`;
                
                respuesta += `### üåê **CONFIGURACI√ìN DE RED**\n`;
                respuesta += `**IP Gateway:** ${guia.ipGateway || '10.0.0.1'}\n`;
                respuesta += `**Puerta de Enlace:** ${guia.puertaEnlace || '10.0.0.254'}\n`;
                respuesta += `**M√°scara de Red:** ${guia.mascaraRed || '255.255.255.0'}\n\n`;
                
                if (guia.notas) {
                    respuesta += `### üìù **NOTAS IMPORTANTES**\n`;
                    respuesta += `${guia.notas}\n\n`;
                }
                
                respuesta += `üí° *¬øNecesitas actualizar esta informaci√≥n? P√≠deme que la actualice.*`;
                
                return respuesta;
            }

            static generarGuiaGenerica(parametros, consultaOriginal) {
                let respuesta = `üîß **Gu√≠a de Conexi√≥n T√©cnica**\n\n`;
                
                respuesta += `### üéØ **PASO 1: ACCESO REMOTO AL SITIO**\n`;
                respuesta += `1. **VPN Corporativa:** Con√©ctate a la VPN usando tus credenciales\n`;
                respuesta += `2. **Acceso por TeamViewer/AnyDesk:** Usa el ID del equipo local\n`;
                respuesta += `3. **Terminal SSH:** \`ssh tecnico@${parametros.ip || '10.0.0.X'}\`\n`;
                respuesta += `   - Usuario: tecnico\n`;
                respuesta += `   - Contrase√±a: **********\n\n`;
                
                respuesta += `### üì° **PASO 2: CONFIGURACI√ìN DE RED**\n`;
                respuesta += `**Para c√°maras nuevas:**\n`;
                respuesta += `1. IP Est√°tica: ${parametros.ip || '10.41.XXX.YYY'}\n`;
                respuesta += `2. Gateway: ${parametros.ip ? parametros.ip.substring(0, parametros.ip.lastIndexOf('.')) + '.1' : '10.41.XXX.1'}\n`;
                respuesta += `3. DNS: 8.8.8.8 / 8.8.4.4\n`;
                respuesta += `4. M√°scara: 255.255.255.0\n\n`;
                
                respuesta += `**Para switches:**\n`;
                respuesta += `1. Acceso: \`telnet ${parametros.ip ? parametros.ip.substring(0, parametros.ip.lastIndexOf('.')) + '.254' : '10.41.XXX.254'}\`\n`;
                respuesta += `2. Usuario: admin\n`;
                respuesta += `3. Contrase√±a: admin123\n\n`;
                
                respuesta += `### üìπ **PASO 3: CONEXI√ìN A C√ÅMARAS**\n`;
                respuesta += `**Navegador Web:**\n`;
                respuesta += `1. Abre Chrome/Firefox\n`;
                respuesta += `2. Ingresa: \`http://${parametros.ip || 'CAMERA_IP'}\`\n`;
                respuesta += `3. Usuario: admin\n`;
                respuesta += `4. Contrase√±a: admin123\n\n`;
                
                respuesta += `**Software NVR:**\n`;
                respuesta += `1. Abre el software de gesti√≥n\n`;
                respuesta += `2. Agrega nueva c√°mara\n`;
                respuesta += `3. Protocolo: ONVIF\n`;
                respuesta += `4. Puerto: 80\n`;
                respuesta += `5. Credenciales predeterminadas\n\n`;
                
                respuesta += `### üõ†Ô∏è **PASO 4: VERIFICACI√ìN**\n`;
                respuesta += `1. Ping a la c√°mara: \`ping ${parametros.ip || 'IP_CAMARA'}\`\n`;
                respuesta += `2. Verifica flujo de video\n`;
                respuesta += `3. Revisa almacenamiento\n`;
                respuesta += `4. Configura grabaci√≥n continua\n\n`;
                
                respuesta += `---\n`;
                respuesta += `ü§ñ **¬øQuieres que guarde esta gu√≠a para ${parametros.sitio || 'este sitio'}?**\n`;
                respuesta += `*Puedo aprender los pasos espec√≠ficos si me los ense√±as.*\n`;
                respuesta += `\`Ejemplo: "Aprende c√≥mo conectarse al sitio SRC-01"\``;
                
                return respuesta;
            }

            static infoPorIP(parametros) {
                if (!parametros.ip) {
                    return `‚ùå **No se detect√≥ una direcci√≥n IP en la consulta.**\n\nEjemplo: "Informaci√≥n de la c√°mara 10.41.25.100"`;
                }
                
                const camara = camerasData.find(c => c.ip === parametros.ip);
                
                if (!camara) {
                    const ipBase = parametros.ip.substring(0, parametros.ip.lastIndexOf('.'));
                    const camarasMismoRango = camerasData.filter(c => c.ip && c.ip.startsWith(ipBase));
                    
                    let respuesta = `üîç **No encontr√© una c√°mara con IP ${parametros.ip}**\n\n`;
                    
                    if (camarasMismoRango.length > 0) {
                        respuesta += `**C√°maras en el mismo rango (${ipBase}.X):**\n`;
                        camarasMismoRango.slice(0, 5).forEach(c => {
                            respuesta += `‚Ä¢ ${c.code} - ${c.ip} - ${c.sitio || 'Sin sitio'} - ${c.estado === 'active' ? '‚úÖ' : '‚ùå'}\n`;
                        });
                    }
                    
                    respuesta += `\nüí° *¬øEs una c√°mara nueva? Puedo ayudarte a agregarla al sistema.*`;
                    
                    return respuesta;
                }
                
                let respuesta = `üéØ **Informaci√≥n de C√°mara por IP**\n\n`;
                respuesta += `**üìç IP:** ${camara.ip}\n`;
                respuesta += `**üî¢ C√≥digo:** ${camara.code}\n`;
                respuesta += `**üìå Tipo:** ${this.obtenerTipoCompleto(camara.tipo)}\n`;
                respuesta += `**üè¢ Sitio:** ${camara.sitio || 'No asignado'}\n`;
                respuesta += `**üåç Ubicaci√≥n:** ${camara.municipio}, ${camara.departamento}\n`;
                respuesta += `**üì° Estado:** ${this.obtenerEstadoTexto(camara.estado)}\n\n`;
                
                respuesta += `**‚öôÔ∏è Configuraci√≥n de Red:**\n`;
                respuesta += `‚Ä¢ Gateway: ${camara.gateway || '10.0.0.1'}\n`;
                respuesta += `‚Ä¢ Switch: ${camara.switch || 'No especificado'}\n`;
                respuesta += `‚Ä¢ √öltima actualizaci√≥n: ${camara.ultimarevision || 'Desconocida'}\n\n`;
                
                if (camara.observaciones) {
                    respuesta += `**üìù Observaciones:**\n${camara.observaciones}\n\n`;
                }
                
                respuesta += `**üîó Acceso r√°pido:**\n`;
                respuesta += `‚Ä¢ Navegador: http://${camara.ip}\n`;
                respuesta += `‚Ä¢ SSH: ssh tecnico@${camara.ip}\n`;
                respuesta += `‚Ä¢ Ping: ping ${camara.ip}\n\n`;
                
                respuesta += `üí° *¬øNecesitas ayuda para conectarte a esta c√°mara?*`;
                
                return respuesta;
            }

            static configuracionRed(parametros) {
                let respuesta = `üåê **Gu√≠a Completa de Configuraci√≥n de Red**\n\n`;
                
                respuesta += `### üéØ **CONCEPTOS B√ÅSICOS**\n`;
                respuesta += `**Direcci√≥n IP:** Identificador √∫nico en la red (ej: 10.41.25.100)\n`;
                respuesta += `**Gateway/Puerta de Enlace:** Salida a otras redes (ej: 10.41.25.1)\n`;
                respuesta += `**M√°scara de Subred:** Define el tama√±o de la red (ej: 255.255.255.0)\n`;
                respuesta += `**DNS:** Servidor de nombres (ej: 8.8.8.8)\n\n`;
                
                respuesta += `### üîß **CONFIGURACI√ìN POR EQUIPO**\n`;
                respuesta += `**Para c√°maras Hikvision/Dahua:**\n`;
                respuesta += `1. Accede v√≠a navegador a la IP actual\n`;
                respuesta += `2. Configuraci√≥n ‚Üí Red ‚Üí TCP/IP\n`;
                respuesta += `3. Modo: Est√°tico\n`;
                respuesta += `4. IP: ${parametros.ip || '10.41.XX.YYY'}\n`;
                respuesta += `5. Gateway: IP del router local\n`;
                respuesta += `6. DNS: 8.8.8.8\n\n`;
                
                respuesta += `**Para switches Cisco/TP-Link:**\n`;
                respuesta += `1. Conexi√≥n consola o SSH\n`;
                respuesta += `2. Comando: \`configure terminal\`\n`;
                respuesta += `3. \`interface vlan 1\`\n`;
                respuesta += `4. \`ip address ${parametros.ip ? parametros.ip.substring(0, parametros.ip.lastIndexOf('.')) + '.254' : '10.41.XX.254'} 255.255.255.0\`\n`;
                respuesta += `5. \`ip default-gateway ${parametros.ip ? parametros.ip.substring(0, parametros.ip.lastIndexOf('.')) + '.1' : '10.41.XX.1'}\`\n`;
                respuesta += `6. \`exit\` y \`write memory\`\n\n`;
                
                respuesta += `### üõ†Ô∏è **COMANDOS DE VERIFICACI√ìN**\n`;
                respuesta += `**Windows:**\n`;
                respuesta += `\`ipconfig\` - Ver configuraci√≥n actual\n`;
                respuesta += `\`ping IP\` - Probar conectividad\n`;
                respuesta += `\`tracert IP\` - Rastrear ruta\n\n`;
                
                respuesta += `**Linux/SSH:**\n`;
                respuesta += `\`ifconfig\` o \`ip addr\`\n`;
                respuesta += `\`netstat -rn\` - Tabla de rutas\n`;
                respuesta += `\`nslookup dominio\` - Verificar DNS\n\n`;
                
                respuesta += `### üîç **SOLUCI√ìN DE PROBLEMAS**\n`;
                respuesta += `1. **No hay ping:** Verificar cable, IP y gateway\n`;
                respuesta += `2. **Sin acceso web:** Verificar puerto 80 y credenciales\n`;
                respuesta += `3. **IP conflictos:** Cambiar a IP √∫nica en la red\n`;
                respuesta += `4. **Sin internet:** Verificar gateway y DNS\n\n`;
                
                respuesta += `üí° *¬øNecesitas configuraci√≥n espec√≠fica para alg√∫n equipo? Preg√∫ntame.*`;
                
                return respuesta;
            }

            static procedimientoDetallado(parametros, consulta) {
                const procedimientosRelevantes = [];
                
                Object.keys(knowledgeBase.procedimientos).forEach(key => {
                    if (consulta.toLowerCase().includes(key.toLowerCase())) {
                        procedimientosRelevantes.push(knowledgeBase.procedimientos[key]);
                    }
                });
                
                if (procedimientosRelevantes.length > 0) {
                    let respuesta = `üìã **Procedimientos Encontrados**\n\n`;
                    
                    procedimientosRelevantes.forEach((proc, index) => {
                        respuesta += `### ${index + 1}. ${proc.titulo}\n`;
                        respuesta += `**Fecha:** ${proc.fecha}\n`;
                        respuesta += `**Pasos:**\n`;
                        
                        proc.pasos.forEach((paso, i) => {
                            respuesta += `${i + 1}. ${paso}\n`;
                        });
                        
                        respuesta += `\n`;
                    });
                    
                    return respuesta;
                }
                
                return this.generarProcedimientoGenerico(consulta);
            }

            static generarProcedimientoGenerico(consulta) {
                let respuesta = `üìù **Procedimiento T√©cnico**\n\n`;
                
                respuesta += `### üéØ **AN√ÅLISIS DEL REQUERIMIENTO**\n`;
                respuesta += `1. Identificar el equipo/sitio objetivo\n`;
                respuesta += `2. Verificar disponibilidad de acceso\n`;
                respuesta += `3. Revisar documentaci√≥n existente\n`;
                respuesta += `4. Preparar herramientas necesarias\n\n`;
                
                respuesta += `### üîß **PREPARACI√ìN**\n`;
                respuesta += `**Herramientas requeridas:**\n`;
                respuesta += `‚Ä¢ Laptop con software de gesti√≥n\n`;
                respuesta += `‚Ä¢ Cable de red/consola\n`;
                respuesta += `‚Ä¢ Credenciales de acceso\n`;
                respuesta += `‚Ä¢ Lista de IPs/documentaci√≥n\n\n`;
                
                respuesta += `**Verificaciones previas:**\n`;
                respuesta += `1. Ping al equipo objetivo\n`;
                respuesta += `2. Acceso VPN activo\n`;
                respuesta += `3. Credenciales actualizadas\n`;
                respuesta += `4. Backup de configuraci√≥n actual\n\n`;
                
                respuesta += `### üöÄ **EJECUCI√ìN**\n`;
                respuesta += `**Paso 1:** Conectar al equipo\n`;
                respuesta += `**Paso 2:** Acceder a interfaz/configuraci√≥n\n`;
                respuesta += `**Paso 3:** Realizar cambios necesarios\n`;
                respuesta += `**Paso 4:** Guardar configuraci√≥n\n`;
                respuesta += `**Paso 5:** Probar funcionamiento\n\n`;
                
                respuesta += `### ‚úÖ **VERIFICACI√ìN**\n`;
                respuesta += `1. Test completo de funcionalidad\n`;
                respuesta += `2. Documentar cambios realizados\n`;
                respuesta += `3. Actualizar base de datos del sistema\n`;
                respuesta += `4. Notificar a partes interesadas\n\n`;
                
                respuesta += `---\n`;
                respuesta += `ü§ñ **¬øQuieres que guarde este procedimiento?**\n`;
                respuesta += `*Puedo crear un procedimiento personalizado si me das los pasos espec√≠ficos.*\n`;
                respuesta += `\`Ejemplo: "Crear procedimiento para reiniciar switch"\``;
                
                return respuesta;
            }

            static aprenderNuevaInfo(consulta) {
                if (consulta.includes('conectarse') || consulta.includes('conexi√≥n')) {
                    return this.solicitarInfoConexion(consulta);
                } else if (consulta.includes('procedimiento') || consulta.includes('paso')) {
                    return this.solicitarInfoProcedimiento(consulta);
                } else if (consulta.includes('configuraci√≥n') || consulta.includes('configurar')) {
                    return this.solicitarInfoConfiguracion(consulta);
                }
                
                return `ü§î **¬øQu√© te gustar√≠a que aprenda?**\n\nPuedo aprender:\n‚Ä¢ C√≥mo conectarse a un sitio/c√°mara\n‚Ä¢ Procedimientos t√©cnicos\n‚Ä¢ Configuraciones espec√≠ficas\n\nEjemplo: *"Aprende c√≥mo conectarse al sitio SRC-01"*`;
            }

            static solicitarInfoConexion(consulta) {
                const sitioMatch = consulta.match(/sitio\s+([A-Z]{3}-\d{2})|([A-Z]{3}-\d{2})/i);
                const sitio = sitioMatch ? (sitioMatch[1] || sitioMatch[2]) : 'NUEVO_SITIO';
                
                setTimeout(() => {
                    this.mostrarFormularioAprendizaje('conexion', sitio);
                }, 100);
                
                return `üìö **Modo Aprendizaje: Conexi√≥n a ${sitio}**\n\nPor favor, completa la informaci√≥n en el formulario que aparecer√°.\n\n*Puedes ense√±arme:*\n‚Ä¢ Pasos espec√≠ficos de conexi√≥n\n‚Ä¢ Credenciales especiales\n‚Ä¢ Configuraciones de red\n‚Ä¢ Notas importantes`;
            }

            static mostrarFormularioAprendizaje(tipo, referencia) {
                const modal = document.createElement('div');
                modal.id = 'learning-modal';
                modal.className = 'modal-overlay';
                modal.style.cssText = 'display: flex; position: fixed; inset: 0; z-index: 9999; align-items: center; justify-content: center; padding: 1rem; background: rgba(0,0,0,0.7);';
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 1rem; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
                        <div style="padding: 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 1rem 1rem 0 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h3 style="font-size: 1.25rem; font-weight: 700;">üß† Ense√±ar al Asistente IA</h3>
                                <button onclick="document.getElementById('learning-modal').remove()" style="padding: 0.5rem; background: rgba(255, 255, 255, 0.2); border: none; border-radius: 50%; cursor: pointer; color: white;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div style="padding: 2rem;">
                            <p style="margin-bottom: 1.5rem; color: #6b7280;">Completa la informaci√≥n para que pueda aprender sobre <strong>${referencia}</strong></p>
                            
                            <form id="learning-form">
                                <input type="hidden" id="learning-type" value="${tipo}">
                                <input type="hidden" id="learning-ref" value="${referencia}">
                                
                                <div style="margin-bottom: 1.5rem;">
                                    <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">T√≠tulo/Descripci√≥n</label>
                                    <input type="text" id="learning-title" required placeholder="Ej: Conexi√≥n al sitio SRC-01" style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #d1d5db;">
                                </div>
                                
                                <div style="margin-bottom: 1.5rem;">
                                    <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Pasos detallados (uno por l√≠nea)</label>
                                    <textarea id="learning-steps" rows="6" required placeholder="Paso 1: Conectar a VPN...
        Paso 2: Acceder a 10.41.25.1...
        Paso 3: Usuario: admin..." style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #d1d5db;"></textarea>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">IP Gateway</label>
                                        <input type="text" id="learning-gateway" placeholder="10.41.25.1" style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #d1d5db;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Puerta de Enlace</label>
                                        <input type="text" id="learning-puerta" placeholder="10.41.25.254" style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #d1d5db;">
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 1.5rem;">
                                    <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Notas importantes</label>
                                    <textarea id="learning-notes" rows="3" placeholder="Credenciales especiales, horarios de mantenimiento, etc." style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #d1d5db;"></textarea>
                                </div>
                                
                                <div style="display: flex; gap: 1rem;">
                                    <button type="button" onclick="guardarAprendizaje()" class="btn" style="flex: 1; background: linear-gradient(135deg, #10b981 0%, #34d399 100%); color: white;">
                                        <i class="fas fa-save"></i> Guardar Conocimiento
                                    </button>
                                    <button type="button" onclick="document.getElementById('learning-modal').remove()" class="btn" style="flex: 1; background: #e5e7eb; color: #374151;">
                                        Cancelar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }

            static soporteTecnico(consulta) {
                let respuesta = `üõ†Ô∏è **Soporte T√©cnico - Diagn√≥stico**\n\n`;
                
                respuesta += `### üîç **DIAGN√ìSTICO R√ÅPIDO**\n`;
                
                if (consulta.includes('no funciona') || consulta.includes('sin video')) {
                    respuesta += `**Problema detectado: C√°mara sin video**\n\n`;
                    respuesta += `**Pasos a seguir:**\n`;
                    respuesta += `1. üîå Verificar alimentaci√≥n el√©ctrica\n`;
                    respuesta += `2. üåê Comprobar conexi√≥n de red (ping)\n`;
                    respuesta += `3. üì° Revisar configuraci√≥n IP\n`;
                    respuesta += `4. üîÑ Reiniciar c√°mara\n`;
                    respuesta += `5. ‚öôÔ∏è Verificar configuraci√≥n NVR\n`;
                } else if (consulta.includes('lento') || consulta.includes('congelado')) {
                    respuesta += `**Problema detectado: Video lento o congelado**\n\n`;
                    respuesta += `**Causas posibles:**\n`;
                    respuesta += `‚Ä¢ üìà Ancho de banda insuficiente\n`;
                    respuesta += `‚Ä¢ üíæ Almacenamiento lleno\n`;
                    respuesta += `‚Ä¢ üî• Sobrecalentamiento del equipo\n`;
                    respuesta += `‚Ä¢ üêõ Error de software\n`;
                } else {
                    respuesta += `**Problema gen√©rico reportado**\n\n`;
                }
                
                respuesta += `\n### üõ†Ô∏è **HERRAMIENTAS DE DIAGN√ìSTICO**\n`;
                respuesta += `**Comandos √∫tiles:**\n`;
                respuesta += `‚Ä¢ \`ping IP_CAMARA\` - Verificar conectividad\n`;
                respuesta += `‚Ä¢ \`tracert IP_CAMARA\` - Rastrear ruta de red\n`;
                respuesta += `‚Ä¢ \`arp -a\` - Ver tabla ARP\n`;
                respuesta += `‚Ä¢ \`netstat\` - Conexiones de red\n\n`;
                
                respuesta += `**Software recomendado:**\n`;
                respuesta += `‚Ä¢ Wireshark - An√°lisis de red\n`;
                respuesta += `‚Ä¢ Advanced IP Scanner\n`;
                respuesta += `‚Ä¢ Putty - Conexiones SSH\n`;
                respuesta += `‚Ä¢ VLC - Test de streams de video\n\n`;
                
                respuesta += `### üìû **ESCALAMIENTO**\n`;
                respuesta += `**Si el problema persiste:**\n`;
                respuesta += `1. Documentar todos los pasos realizados\n`;
                respuesta += `2. Capturar pantallas de errores\n`;
                respuesta += `3. Contactar a soporte nivel 2\n`;
                respuesta += `4. Referencia de ticket: TICKET-${Date.now().toString().slice(-6)}\n\n`;
                
                respuesta += `üí° *¬øNecesitas ayuda m√°s espec√≠fica? Describe el problema con m√°s detalle.*`;
                
                return respuesta;
            }

            static generarReporte(parametros) {
                const ahora = new Date();
                let respuesta = `üìä **Reporte del Sistema - ${ahora.toLocaleDateString('es-HN')}**\n\n`;
                
                const totalCamaras = camerasData.length;
                const activas = camerasData.filter(c => c.estado === 'active').length;
                const inactivas = camerasData.filter(c => c.estado === 'inactive').length;
                const mantenimiento = camerasData.filter(c => c.estado === 'maintenance').length;
                
                respuesta += `### üìà **ESTAD√çSTICAS GLOBALES**\n`;
                respuesta += `**Total de c√°maras:** ${totalCamaras}\n`;
                respuesta += `**Estado operativo:** ${Math.round((activas/totalCamaras)*100)}%\n`;
                respuesta += `**C√°maras activas:** ${activas}\n`;
                respuesta += `**C√°maras inactivas:** ${inactivas}\n`;
                respuesta += `**En mantenimiento:** ${mantenimiento}\n\n`;
                
                respuesta += `### üéØ **DISTRIBUCI√ìN POR TIPO**\n`;
                const tipos = {};
                camerasData.forEach(cam => {
                    const tipo = this.obtenerTipoCompleto(cam.tipo);
                    if (!tipos[tipo]) tipos[tipo] = { total: 0, activas: 0 };
                    tipos[tipo].total++;
                    if (cam.estado === 'active') tipos[tipo].activas++;
                });
                
                Object.entries(tipos).forEach(([tipo, datos]) => {
                    const porcentaje = Math.round((datos.activas/datos.total)*100);
                    respuesta += `**${tipo}:** ${datos.total} (${datos.activas} activas - ${porcentaje}%)\n`;
                });
                
                respuesta += `\n`;
                
                respuesta += `### üåç **DISTRIBUCI√ìN POR DEPARTAMENTO**\n`;
                const porDepto = {};
                camerasData.forEach(cam => {
                    if (!porDepto[cam.departamento]) porDepto[cam.departamento] = { total: 0, activas: 0 };
                    porDepto[cam.departamento].total++;
                    if (cam.estado === 'active') porDepto[cam.departamento].activas++;
                });
                
                Object.entries(porDepto).forEach(([depto, datos]) => {
                    const porcentaje = Math.round((datos.activas/datos.total)*100);
                    respuesta += `**${depto}:** ${datos.total} c√°maras (${porcentaje}% operativas)\n`;
                });
                
                respuesta += `\n`;
                
                const camarasCriticas = camerasData.filter(c => 
                    c.estado === 'inactive' && 
                    (!c.ultimarevision || (new Date() - new Date(c.ultimarevision)) > 30*24*60*60*1000)
                );
                
                if (camarasCriticas.length > 0) {
                    respuesta += `### ‚ö†Ô∏è **ALERTAS CR√çTICAS**\n`;
                    respuesta += `**C√°maras inactivas por m√°s de 30 d√≠as:**\n`;
                    camarasCriticas.slice(0, 5).forEach(cam => {
                        respuesta += `‚Ä¢ ${cam.code} - ${cam.sitio || 'Sin sitio'} - ${cam.ip || 'Sin IP'}\n`;
                    });
                    
                    if (camarasCriticas.length > 5) {
                        respuesta += `*... y ${camarasCriticas.length - 5} m√°s*\n`;
                    }
                    respuesta += `\n`;
                }
                
                respuesta += `### üí° **RECOMENDACIONES**\n`;
                if (inactivas > 0) {
                    respuesta += `‚Ä¢ Revisar ${inactivas} c√°maras inactivas\n`;
                }
                if (mantenimiento > 0) {
                    respuesta += `‚Ä¢ Completar mantenimiento pendiente de ${mantenimiento} c√°maras\n`;
                }
                if (activas/totalCamaras < 0.9) {
                    respuesta += `‚Ä¢ Mejorar tasa de operatividad (actual: ${Math.round((activas/totalCamaras)*100)}%)\n`;
                }
                
                respuesta += `\n`;
                respuesta += `**Reporte generado:** ${ahora.toLocaleString('es-HN')}\n`;
                respuesta += `**Sistema:** 911 Gesti√≥n de C√°maras v4.0\n`;
                
                return respuesta;
            }

            static respuestaGeneral(consulta, analisis) {
                const conocimientoRelevante = knowledgeBase.conocimientoAprendido.find(item => 
                    consulta.toLowerCase().includes(item.palabraClave.toLowerCase())
                );
                
                if (conocimientoRelevante) {
                    return `üí° **Informaci√≥n relacionada:**\n\n${conocimientoRelevante.informacion}\n\n*¬øTe sirvi√≥ esta informaci√≥n?*`;
                }
                
                let respuesta = `ü§ñ **Asistente IA 911 - Sistema Inteligente**\n\n`;
                
                respuesta += `He analizado tu consulta y detect√© que necesitas informaci√≥n sobre el sistema.\n\n`;
                
                respuesta += `**Puedo ayudarte con:**\n`;
                respuesta += `‚Ä¢ üìä Conteo de c√°maras (LPR, PTZ, Fijas)\n`;
                respuesta += `‚Ä¢ üîå Gu√≠as de conexi√≥n paso a paso\n`;
                respuesta += `‚Ä¢ üåê Configuraci√≥n de red (IP, Gateway, DNS)\n`;
                respuesta += `‚Ä¢ üõ†Ô∏è Soporte t√©cnico y soluci√≥n de problemas\n`;
                respuesta += `‚Ä¢ üìã Procedimientos detallados\n`;
                respuesta += `‚Ä¢ üìà Reportes y estad√≠sticas\n`;
                respuesta += `‚Ä¢ üß† Aprender nueva informaci√≥n\n\n`;
                
                respuesta += `**Ejemplos de consultas:**\n`;
                respuesta += `‚Ä¢ "¬øCu√°ntas LPR en Santa Rosa de Cop√°n?"\n`;
                respuesta += `‚Ä¢ "C√≥mo conectarse al sitio SRC-01 paso a paso"\n`;
                respuesta += `‚Ä¢ "Configuraci√≥n de red para c√°mara 10.41.25.100"\n`;
                respuesta += `‚Ä¢ "Procedimiento para reiniciar switch"\n`;
                respuesta += `‚Ä¢ "Ense√±ar c√≥mo acceder al sitio OCO-02"\n\n`;
                
                respuesta += `üí° *Soy m√°s √∫til cuando me das detalles espec√≠ficos.*`;
                
                return respuesta;
            }

            static obtenerTipoCompleto(codigoTipo) {
                const tipos = {
                    'F1': 'Fija HD',
                    'F2': 'Fija 4K',
                    'F3': 'Fija 360¬∞',
                    'P1': 'PTZ Motorizada',
                    'L1': 'LPR (Reconocimiento de Placas)'
                };
                return tipos[codigoTipo] || codigoTipo;
            }

            static obtenerEstadoTexto(estado) {
                const estados = {
                    'active': '‚úÖ Activa',
                    'inactive': '‚ùå Inactiva',
                    'maintenance': 'üîß En Mantenimiento'
                };
                return estados[estado] || estado;
            }
        }

        // ==================== FUNCIONES DEL ASISTENTE IA ====================
        function askAI(question) {
            const aiInput = document.getElementById('ai-input');
            if (aiInput) {
                aiInput.value = question;
                sendAIQuestion();
            }
        }

        function sendAIQuestion() {
            const input = document.getElementById('ai-input');
            const question = input.value.trim();
            
            if (!question) return;
            
            addMessageToChat(question, 'user');
            input.value = '';
            
            showAILoading();
            
            setTimeout(() => {
                const analisis = AnalizadorConsultas.analizar(question);
                const response = GeneradorRespuestasIA.generarRespuesta(question, analisis);
                addMessageToChat(response, 'ai');
                hideAILoading();
                
                aiHistory.push({
                    question,
                    response,
                    timestamp: new Date().toISOString()
                });
                
                localStorage.setItem(STORAGEKEYS.AIHISTORY, JSON.stringify(aiHistory));
            }, 1000);
        }

        function addMessageToChat(message, type) {
            const chatHistory = document.getElementById('chat-history');
            if (!chatHistory) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'user' ? 'message-user' : 'message-ai';
            messageDiv.classList.add('fade-in');
            
            if (type === 'user') {
                messageDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                        <div style="width: 24px; height: 24px; border-radius: 50%; background: rgba(255, 255, 255, 0.2); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-user" style="font-size: 0.75rem;"></i>
                        </div>
                        <div style="font-weight: 600;">T√∫</div>
                    </div>
                    <p style="margin: 0; white-space: pre-wrap;">${escapeHtml(message)}</p>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <div style="width: 24px; height: 24px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-robot" style="font-size: 0.75rem; color: white;"></i>
                        </div>
                        <div style="font-weight: 600; color: #667eea;">Asistente IA 911</div>
                    </div>
                    <div style="margin: 0; white-space: pre-wrap; line-height: 1.5;">${formatAIResponse(message)}</div>
                `;
            }
            
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        function formatAIResponse(response) {
            if (typeof response !== 'string') return response;
            
            let formatted = response
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/### (.*?)\n/g, '<h4 style="margin: 1rem 0 0.5rem; font-size: 1rem; font-weight: 600; color: #374151;">$1</h4>')
                .replace(/## (.*?)\n/g, '<h3 style="margin: 1.25rem 0 0.75rem; font-size: 1.125rem; font-weight: 700; color: #1f2937;">$1</h3>')
                .replace(/\n/g, '<br>')
                .replace(/\‚Ä¢ /g, '‚Ä¢ ')
                .replace(/\`(.*?)\`/g, '<code style="background: rgba(0,0,0,0.05); padding: 2px 4px; border-radius: 3px; font-family: monospace;">$1</code>');
            
            return formatted;
        }

        function showAILoading() {
            const sendBtn = document.getElementById('send-ai-btn');
            if (sendBtn) {
                sendBtn.innerHTML = '<div class="loading"></div>';
                sendBtn.disabled = true;
            }
        }

        function hideAILoading() {
            const sendBtn = document.getElementById('send-ai-btn');
            if (sendBtn) {
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                sendBtn.disabled = false;
            }
        }

        function clearChat() {
            const chatHistory = document.getElementById('chat-history');
            if (!chatHistory) return;
            
            if (confirm('¬øEst√°s seguro de limpiar el historial del chat?')) {
                chatHistory.innerHTML = `
                    <div class="message-ai fade-in">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <div style="width: 24px; height: 24px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-robot" style="font-size: 0.75rem; color: white;"></i>
                            </div>
                            <div style="font-weight: 600; color: #667eea;">Asistente IA 911 - Sistema Inteligente</div>
                        </div>
                        <div style="margin: 0; white-space: pre-wrap; line-height: 1.5;">
                            ¬°Hola! Soy tu asistente inteligente especializado en el sistema de c√°maras 911. ¬øEn qu√© puedo ayudarte hoy?
                        </div>
                    </div>
                `;
                
                aiHistory = [];
                localStorage.setItem(STORAGEKEYS.AIHISTORY, JSON.stringify(aiHistory));
            }
        }

        // ==================== FUNCIONES DE APRENDIZAJE ====================
        function guardarAprendizaje() {
            const tipo = document.getElementById('learning-type').value;
            const referencia = document.getElementById('learning-ref').value;
            const titulo = document.getElementById('learning-title').value;
            const pasos = document.getElementById('learning-steps').value;
            const gateway = document.getElementById('learning-gateway').value;
            const puerta = document.getElementById('learning-puerta').value;
            const notas = document.getElementById('learning-notes').value;
            
            if (!titulo || !pasos) {
                showNotification('‚ö†Ô∏è T√≠tulo y pasos son obligatorios', 'error');
                return;
            }
            
            if (tipo === 'conexion') {
                if (!knowledgeBase.conexionesSitios[referencia]) {
                    knowledgeBase.conexionesSitios[referencia] = {};
                }
                
                knowledgeBase.conexionesSitios[referencia] = {
                    titulo,
                    pasos: pasos.split('\n').filter(p => p.trim()),
                    ipGateway: gateway,
                    puertaEnlace: puerta,
                    notas,
                    fechaActualizacion: new Date().toISOString().split('T')[0],
                    autor: 'Usuario'
                };
                
                knowledgeBase.conocimientoAprendido.push({
                    palabraClave: referencia,
                    informacion: `Conexi√≥n a ${referencia}: ${titulo}`,
                    tipo: 'conexion',
                    fecha: new Date().toISOString()
                });
            }
            
            saveKnowledgeBase();
            
            document.getElementById('learning-modal').remove();
            
            showNotification(`‚úÖ Conocimiento guardado para ${referencia}`, 'success');
            
            const respuesta = `üß† **¬°He aprendido!**\n\nAhora conozco c√≥mo conectarse a **${referencia}**.\n\nPuedes preguntarme: "¬øC√≥mo conectarse a ${referencia}?" y te dar√© los pasos espec√≠ficos.`;
            addMessageToChat(respuesta, 'ai');
        }

        // ==================== FUNCIONES DEL MAPA ====================
        function toggleMapConfig() {
            const config = document.getElementById('map-config');
            config.style.display = config.style.display === 'block' ? 'none' : 'block';
        }

        function applyMapSettings() {
            const url = document.getElementById('map-url').value;
            const width = document.getElementById('map-width').value;
            const height = document.getElementById('map-height').value;
            const map = document.getElementById('main-map');
            
            map.src = url;
            map.style.width = width + '%';
            map.style.height = height + 'px';
            
            const settings = {
                url,
                width,
                height
            };
            localStorage.setItem('mapSettings', JSON.stringify(settings));
            
            showNotification('‚úÖ Configuraci√≥n del mapa aplicada', 'success');
            toggleMapConfig();
        }

        function resetMapSettings() {
            document.getElementById('map-url').value = 'https://www.google.com/maps/d/embed?mid=156urWy3HLJdu7wGK8gHTFX4K1oXIasE&ehbc=2E312F&noprof=1';
            document.getElementById('map-width').value = 100;
            document.getElementById('map-height').value = 400;
            
            const map = document.getElementById('main-map');
            map.src = document.getElementById('map-url').value;
            map.style.width = '100%';
            map.style.height = '400px';
            
            localStorage.removeItem('mapSettings');
            showNotification('‚úÖ Configuraci√≥n del mapa restablecida', 'success');
        }

        function editMapSettings() {
            toggleMapConfig();
        }

        function refreshMap() {
            const map = document.getElementById('main-map');
            const currentSrc = map.src;
            map.src = '';
            setTimeout(() => {
                map.src = currentSrc;
                updateMapTime();
                showNotification('‚úÖ Mapa actualizado', 'success');
            }, 300);
        }

        function toggleMapFullscreen() {
            const mapContainer = document.getElementById('map-container');
            if (!document.fullscreenElement) {
                if (mapContainer.requestFullscreen) {
                    mapContainer.requestFullscreen();
                } else if (mapContainer.mozRequestFullScreen) {
                    mapContainer.mozRequestFullScreen();
                } else if (mapContainer.webkitRequestFullscreen) {
                    mapContainer.webkitRequestFullscreen();
                } else if (mapContainer.msRequestFullscreen) {
                    mapContainer.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        }

        function loadMapSettings() {
            const saved = localStorage.getItem('mapSettings');
            if (saved) {
                try {
                    const settings = JSON.parse(saved);
                    document.getElementById('map-url').value = settings.url;
                    document.getElementById('map-width').value = settings.width;
                    document.getElementById('map-height').value = settings.height;
                    
                    const map = document.getElementById('main-map');
                    map.src = settings.url;
                    map.style.width = settings.width + '%';
                    map.style.height = settings.height + 'px';
                } catch (e) {
                    console.error('Error loading map settings:', e);
                }
            }
        }

        function copyMapUrl() {
            const url = document.getElementById('map-url').value;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url).then(() => {
                    showNotification('üìã URL del mapa copiada al portapapeles', 'success');
                }).catch(err => {
                    fallbackCopyMapUrl(url);
                });
            } else {
                fallbackCopyMapUrl(url);
            }
        }

        function fallbackCopyMapUrl(url) {
            const textArea = document.createElement('textarea');
            textArea.value = url;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                document.execCommand('copy');
                showNotification('üìã URL del mapa copiada', 'success');
            } catch (err) {
                showNotification('‚ùå No se pudo copiar. Usa Ctrl+C manualmente', 'error');
            }
            
            document.body.removeChild(textArea);
        }

        // ==================== FUNCIONALIDADES GENERALES ====================
        function toggleEditMode() {
            editMode = !editMode;
            const btn = document.getElementById('edit-mode-btn');
            if (editMode) {
                btn.innerHTML = '<i class="fas fa-check"></i> Terminar';
                btn.style.background = 'linear-gradient(135deg, #10b981 0%, #34d399 100%)';
                btn.style.color = 'white';
            } else {
                btn.innerHTML = '<i class="fas fa-edit"></i> Editar';
                btn.style.background = '';
                btn.style.color = '';
            }
            renderCameras();
        }

        function toggleNavPanel() {
            const panel = document.getElementById('nav-panel');
            if (panel.classList.contains('active')) {
                panel.classList.remove('active');
            } else {
                panel.classList.add('active');
                document.getElementById('assistant-panel').classList.remove('active');
            }
        }

        function toggleAssistantPanel() {
            const panel = document.getElementById('assistant-panel');
            if (panel.classList.contains('active')) {
                panel.classList.remove('active');
            } else {
                panel.classList.add('active');
                document.getElementById('nav-panel').classList.remove('active');
                updateTokenInfo();
            }
        }

        function updateTokenInfo() {
            const info = document.getElementById('token-info');
            if (info) {
                info.textContent = `Contexto: ${camerasData.length} c√°maras`;
            }
        }

        function exportData() {
            try {
                const exportData = {
                    camaras: camerasData,
                    sitios: sitesData,
                    fecha: new Date().toISOString(),
                    version: '4.0'
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileName = `sistema911_export_${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileName);
                linkElement.click();
                
                showNotification('üì• Datos exportados exitosamente', 'success');
            } catch (error) {
                console.error('Error exporting:', error);
                showNotification('‚ùå Error al exportar datos', 'error');
            }
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (data.camaras && Array.isArray(data.camaras)) {
                            if (confirm(`¬øImportar ${data.camaras.length} c√°maras? Esto reemplazar√° los datos actuales.`)) {
                                camerasData = data.camaras;
                                if (data.sitios) sitesData = data.sitios;
                                saveData();
                                applyAllFilters();
                                showNotification(`‚úÖ ${data.camaras.length} c√°maras importadas exitosamente`, 'success');
                            }
                        } else {
                            showNotification('‚ùå Formato de archivo inv√°lido', 'error');
                        }
                    } catch (error) {
                        console.error('Error importing:', error);
                        showNotification('‚ùå Error al importar el archivo', 'error');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // ==================== UTILIDADES ====================
        function updateTime() {
            const now = new Date();
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                timeElement.textContent = now.toLocaleDateString('es-HN', options);
            }
        }

        function updateMapTime() {
            const timeElement = document.getElementById('map-update-time');
            if (timeElement) {
                timeElement.textContent = `√öltima actualizaci√≥n ${new Date().toLocaleTimeString('es-HN')}`;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            
            let bgGradient = 'linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%)';
            let icon = 'info-circle';
            
            if (type === 'success') {
                bgGradient = 'linear-gradient(135deg, #10b981 0%, #34d399 100%)';
                icon = 'check-circle';
            } else if (type === 'error') {
                bgGradient = 'linear-gradient(135deg, #ef4444 0%, #f87171 100%)';
                icon = 'exclamation-circle';
            }
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 0.75rem;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
                color: white;
                z-index: 9999;
                background: ${bgGradient};
                animation: slideIn 0.3s ease-out;
                max-width: 400px;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <i class="fas fa-${icon}" style="font-size: 1.25rem;"></i>
                    <span style="font-weight: 500;">${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                notification.style.transition = 'all 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        function copiarAlPortapapeles(texto) {
            navigator.clipboard.writeText(texto).then(() => {
                showNotification(`üìã Copiado: ${texto}`, 'success');
            });
        }

        // ==================== GESTI√ìN DE DEPARTAMENTOS ====================
        function showDepartmentManager() {
            const modal = document.createElement('div');
            modal.id = 'dept-manager-modal';
            modal.className = 'modal-overlay';
            modal.style.cssText = 'display: flex; position: fixed; inset: 0; z-index: 50; align-items: center; justify-content: center; padding: 1rem;';
            
            modal.innerHTML = `
                <div class="modal-content" style="background: white; border-radius: 1rem; width: 100%; max-width: 60rem; max-height: 90vh; overflow-y: auto;">
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 1rem 1rem 0 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="font-size: 1.5rem; font-weight: 700;">üóÇÔ∏è Gesti√≥n de Departamentos y Municipios</h3>
                            <button onclick="closeDepartmentManager()" style="padding: 0.5rem; background: rgba(255, 255, 255, 0.2); border: none; border-radius: 50%; cursor: pointer; color: white;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div style="padding: 2rem;">
                        <div style="margin-bottom: 2rem;">
                            <button onclick="showAddDepartmentForm()" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Nuevo Departamento
                            </button>
                        </div>
                        
                        <div id="departments-list"></div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            renderDepartmentsList();
        }

        function closeDepartmentManager() {
            const modal = document.getElementById('dept-manager-modal');
            if (modal) modal.remove();
        }

        function renderDepartmentsList() {
            const container = document.getElementById('departments-list');
            if (!container) return;
            
            container.innerHTML = '';
            
            Object.entries(estructuraDatos.departamentos).forEach(([deptName, deptData]) => {
                const deptCard = document.createElement('div');
                deptCard.className = 'card';
                deptCard.style.marginBottom = '1.5rem';
                
                deptCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="font-size: 1.25rem; font-weight: 700; color: #667eea;">
                            <i class="fas fa-map-marked-alt"></i> ${deptName}
                        </h4>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="editDepartmentName('${deptName}')" class="btn" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6; padding: 0.5rem 1rem;">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button onclick="deleteDepartment('${deptName}')" class="btn" style="background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 0.5rem 1rem;">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </div>
                    </div>
                    
                    <div style="background: #f9fafb; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <p><strong>Total de c√°maras:</strong> ${deptData.totalCamaras}</p>
                        <p><strong>Municipios:</strong> ${Object.keys(deptData.municipios).length}</p>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                            <h5 style="font-weight: 600;">Municipios:</h5>
                            <button onclick="showAddMunicipioForm('${deptName}')" class="btn" style="background: rgba(16, 185, 129, 0.1); color: #10b981; padding: 0.5rem 1rem;">
                                <i class="fas fa-plus"></i> Agregar Municipio
                            </button>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">
                            ${Object.entries(deptData.municipios).map(([munName, munData]) => `
                                <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                        <h6 style="font-weight: 600; color: #374151;">${munName}</h6>
                                        <div style="display: flex; gap: 0.25rem;">
                                            <button onclick="editMunicipio('${deptName}', '${munName}')" style="padding: 0.25rem 0.5rem; background: #f3f4f6; border: none; border-radius: 0.25rem; cursor: pointer;">
                                                <i class="fas fa-edit" style="font-size: 0.75rem;"></i>
                                            </button>
                                            <button onclick="deleteMunicipio('${deptName}', '${munName}')" style="padding: 0.25rem 0.5rem; background: #fee2e2; border: none; border-radius: 0.25rem; cursor: pointer; color: #dc2626;">
                                                <i class="fas fa-trash" style="font-size: 0.75rem;"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div style="font-size: 0.875rem; color: #6b7280;">
                                        <p>üìπ C√°maras: ${munData.camaras}</p>
                                        <p>üìç Sitios: ${munData.sitios}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                container.appendChild(deptCard);
            });
        }

        function showAddDepartmentForm() {
            const form = prompt('Nombre del nuevo departamento:');
            if (!form || form.trim() === '') return;
            
            const deptName = form.trim();
            
            if (estructuraDatos.departamentos[deptName]) {
                showNotification('‚ö†Ô∏è Este departamento ya existe', 'error');
                return;
            }
            
            estructuraDatos.departamentos[deptName] = {
                totalCamaras: 0,
                municipios: {}
            };
            
            saveEstructuraDatos();
            loadDeptFilterOptions();
            updateDepartmentSelectors();
            renderDepartmentsList();
            showNotification('‚úÖ Departamento creado exitosamente', 'success');
        }

        function editDepartmentName(oldName) {
            const newName = prompt('Nuevo nombre para el departamento:', oldName);
            if (!newName || newName.trim() === '' || newName === oldName) return;
            
            if (estructuraDatos.departamentos[newName]) {
                showNotification('‚ö†Ô∏è Ya existe un departamento con ese nombre', 'error');
                return;
            }
            
            estructuraDatos.departamentos[newName] = estructuraDatos.departamentos[oldName];
            delete estructuraDatos.departamentos[oldName];
            
            camerasData.forEach(cam => {
                if (cam.departamento === oldName) {
                    cam.departamento = newName;
                }
            });
            
            saveEstructuraDatos();
            saveData();
            loadDeptFilterOptions();
            updateDepartmentSelectors();
            renderDepartmentsList();
            updateUI();
            showNotification('‚úÖ Departamento renombrado exitosamente', 'success');
        }

        function deleteDepartment(deptName) {
            const camerasEnDept = camerasData.filter(c => c.departamento === deptName).length;
            
            if (camerasEnDept > 0) {
                if (!confirm(`Este departamento tiene ${camerasEnDept} c√°maras asignadas. ¬øEst√°s seguro de eliminarlo? Las c√°maras quedar√°n sin departamento.`)) {
                    return;
                }
            }
            
            if (!confirm(`¬øEliminar el departamento "${deptName}"?`)) return;
            
            delete estructuraDatos.departamentos[deptName];
            
            saveEstructuraDatos();
            loadDeptFilterOptions();
            updateDepartmentSelectors();
            renderDepartmentsList();
            showNotification('üóëÔ∏è Departamento eliminado', 'success');
        }

        function showAddMunicipioForm(deptName) {
            const munName = prompt('Nombre del municipio:');
            if (!munName || munName.trim() === '') return;
            
            if (estructuraDatos.departamentos[deptName].municipios[munName.trim()]) {
                showNotification('‚ö†Ô∏è Este municipio ya existe en el departamento', 'error');
                return;
            }
            
            const camaras = parseInt(prompt('N√∫mero de c√°maras:', '0')) || 0;
            const sitios = parseInt(prompt('N√∫mero de sitios:', '0')) || 0;
            
            estructuraDatos.departamentos[deptName].municipios[munName.trim()] = {
                camaras: camaras,
                sitios: sitios
            };
            
            estructuraDatos.departamentos[deptName].totalCamaras = 
                Object.values(estructuraDatos.departamentos[deptName].municipios)
                    .reduce((sum, m) => sum + m.camaras, 0);
            
            saveEstructuraDatos();
            
            if (currentDeptFilter === deptName) {
                loadMunFilterOptions(deptName);
            }
            
            renderDepartmentsList();
            showNotification('‚úÖ Municipio agregado exitosamente', 'success');
        }

        function editMunicipio(deptName, munName) {
            const munData = estructuraDatos.departamentos[deptName].municipios[munName];
            
            const newName = prompt('Nombre del municipio:', munName);
            if (!newName || newName.trim() === '') return;
            
            const camaras = parseInt(prompt('N√∫mero de c√°maras:', munData.camaras)) || 0;
            const sitios = parseInt(prompt('N√∫mero de sitios:', munData.sitios)) || 0;
            
            if (newName !== munName) {
                if (estructuraDatos.departamentos[deptName].municipios[newName]) {
                    showNotification('‚ö†Ô∏è Ya existe un municipio con ese nombre', 'error');
                    return;
                }
                delete estructuraDatos.departamentos[deptName].municipios[munName];
                
                camerasData.forEach(cam => {
                    if (cam.departamento === deptName && cam.municipio === munName) {
                        cam.municipio = newName;
                    }
                });
            }
            
            estructuraDatos.departamentos[deptName].municipios[newName] = {
                camaras: camaras,
                sitios: sitios
            };
            
            estructuraDatos.departamentos[deptName].totalCamaras = 
                Object.values(estructuraDatos.departamentos[deptName].municipios)
                    .reduce((sum, m) => sum + m.camaras, 0);
            
            saveEstructuraDatos();
            saveData();
            
            if (currentDeptFilter === deptName) {
                loadMunFilterOptions(deptName);
            }
            
            renderDepartmentsList();
            updateUI();
            showNotification('‚úÖ Municipio actualizado exitosamente', 'success');
        }

        function deleteMunicipio(deptName, munName) {
            const camerasEnMun = camerasData.filter(c => c.departamento === deptName && c.municipio === munName).length;
            
            if (camerasEnMun > 0) {
                if (!confirm(`Este municipio tiene ${camerasEnMun} c√°maras. ¬øEliminar de todos modos?`)) {
                    return;
                }
            }
            
            delete estructuraDatos.departamentos[deptName].municipios[munName];
            
            estructuraDatos.departamentos[deptName].totalCamaras = 
                Object.values(estructuraDatos.departamentos[deptName].municipios)
                    .reduce((sum, m) => sum + m.camaras, 0);
            
            saveEstructuraDatos();
            
            if (currentDeptFilter === deptName) {
                loadMunFilterOptions(deptName);
            }
            
            renderDepartmentsList();
            showNotification('üóëÔ∏è Municipio eliminado', 'success');
        }

        function updateDepartmentSelectors() {
            const selectors = document.querySelectorAll('#camera-dept, #site-dept');
            selectors.forEach(select => {
                const currentValue = select.value;
                
                select.innerHTML = '';
                
                Object.keys(estructuraDatos.departamentos).forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept;
                    option.textContent = dept;
                    if (dept === currentValue) option.selected = true;
                    select.appendChild(option);
                });
            });
        }

        // ==================== INICIALIZACI√ìN DEL SISTEMA ====================
        function initSystem() {
            loadDeptFilterOptions();
            loadMunFilterOptions('all');
            updateDepartmentSelectors();
            loadMapSettings();
            updateTokenInfo();
            
            document.getElementById('camera-dept')?.addEventListener('change', function() {
                updateMunicipioSelect('camera-dept', 'camera-mun');
            });
            
            document.getElementById('site-dept')?.addEventListener('change', function() {
                updateMunicipioSelect('site-dept', 'site-mun');
            });
            
            console.log('%cüöÄ Sistema 911 - Gesti√≥n Inteligente de C√°maras v4.0', 'color: #667eea; font-size: 20px; font-weight: bold;');
            console.log('%c‚úÖ Sistema IA inteligente inicializado correctamente', 'color: #10b981; font-size: 14px;');
            console.log(`%cüìä Estad√≠sticas: ${camerasData.length} c√°maras cargadas`, 'color: #3b82f6; font-size: 12px;');
            console.log(`%cüìö Base de conocimiento: ${Object.keys(knowledgeBase.conexionesSitios).length} sitios aprendidos`, 'color: #8b5cf6; font-size: 12px;');
        }

        // ==================== MANEJADORES DE EVENTOS ====================
        document.addEventListener('click', function(event) {
            const editModal = document.getElementById('edit-modal');
            const detailsModal = document.getElementById('details-modal');
            const siteModal = document.getElementById('site-modal');
            
            if (event.target === editModal) {
                closeModal();
            }
            if (event.target === detailsModal) {
                closeDetailsModal();
            }
            if (event.target === siteModal) {
                closeSiteModal();
            }
        });

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const editModal = document.getElementById('edit-modal');
                const detailsModal = document.getElementById('details-modal');
                const siteModal = document.getElementById('site-modal');
                const mapConfig = document.getElementById('map-config');
                const learningModal = document.getElementById('learning-modal');
                const deptModal = document.getElementById('dept-manager-modal');
                
                if (editModal.style.display === 'flex') {
                    closeModal();
                } else if (detailsModal.style.display === 'flex') {
                    closeDetailsModal();
                } else if (siteModal.style.display === 'flex') {
                    closeSiteModal();
                } else if (mapConfig.style.display === 'block') {
                    toggleMapConfig();
                } else if (learningModal) {
                    learningModal.remove();
                } else if (deptModal) {
                    closeDepartmentManager();
                }
            }
            
            if (event.ctrlKey && event.key === 'f') {
                event.preventDefault();
                const searchInput = document.getElementById('search-cameras');
                if (searchInput) {
                    searchInput.focus();
                    searchInput.select();
                }
            }
            
            if (event.ctrlKey && event.key === 'n') {
                event.preventDefault();
                addNewCamera();
            }
            
            if (event.ctrlKey && event.key === 'e') {
                event.preventDefault();
                exportData();
            }
        });
    </script>
</body>
</html>
